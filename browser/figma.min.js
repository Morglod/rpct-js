!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).RPCT=e()}}(function(){var e={};Object.defineProperty(e,"__esModule",{value:!0}),e.cloneJSON=function(e){return JSON.parse(JSON.stringify(e))},e.simpleCountGenerator=function(){let e=0;return()=>(e>=Number.MAX_SAFE_INTEGER-5&&(e=0),++e)},e.unsafeUUIDGenerator=function(){return()=>`${Date.now()}-${Math.floor(9999*Math.random()).toString(16)}-${Math.floor(9999*Math.random()).toString(16)}`};var t={};Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultConfig={version:"0.1.0",debug:!1,uuidGeneratorFactory:e.unsafeUUIDGenerator};var n={},i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(r,s){function o(e){try{u(i.next(e))}catch(t){s(t)}}function a(e){try{u(i.throw(e))}catch(t){s(t)}}function u(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(o,a)}u((i=i.apply(e,t||[])).next())})};Object.defineProperty(n,"__esModule",{value:!0}),n.Api=class{constructor(e,n,r=t.DefaultConfig,s=""){this.debugName=s,this.handleRemoteCall=(e=>{this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: "${JSON.stringify(e)}"`);const t=e;let n;if(!t)throw new Error("Api: handleRemoteCall failed, undefined data");if(t.method){if(!this.methods||!this.methods[t.method])return void console.error(`method '${t.method}' not found`);this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: found selfMethod data.method="${t.method}"`),n=this.methods[t.method]}else{if(!t.callback)return void console.error("not method & not callback");if(this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: it has a callback call request data.callback="${t.callback}"`),!this.callbacks[t.callback])return void console.error(`callback '${t.method}' not found`);this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: found callback="${t.callback}"`),n=this.callbacks[t.callback]}this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: processing data.args`);const i=t.args.map((e,t)=>e.callback?(this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: callback at ${t} arg index, returning proxy`),(...n)=>(this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: proxy call for ${t} arg index, callbackArgs="${JSON.stringify(n)}", callback="${e.callback}"`),this._call({callback:e.callback,args:n}))):e.value);return this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: invoking func`),n(...i)}),this._call=(e=>i(this,void 0,void 0,function*(){this.config.debug&&console.log(`Api_${this.debugName} call: params="${JSON.stringify(e)}"`);const t=[],n={method:e.method,callback:e.callback,args:e.args.map((e,n)=>{if("function"==typeof e){const i=`${this.nextUUID()}`;return t.push(i),this.callbacks[i]=e,this.config.debug&&console.log(`Api_${this.debugName} call: found func arg at ${n} index, bound a callback as callbackUUID="${i}"`),{callback:i}}return{value:e}})};this.config.debug&&console.log(`Api_${this.debugName} call: sending request to transport`);const i=yield this.transport.request(n);for(const e of t)delete this.callbacks[e];return i})),this.callMethod=((e,...t)=>this._call({method:e,args:t})),this.callbacks={},this.nextUUID=r.uuidGeneratorFactory(),this.methods=e,this.transport=n,this.config=r,n.setRequestHandler(this.handleRemoteCall)}};var r={};Object.defineProperty(r,"__esModule",{value:!0});class s extends Error{constructor(e,t){super(e),this.uuid=t}}r.TicketListAnswerError=s;class o{constructor(){this.ask=(e=>{const t=null===e?this.nextUUID():e,n=new Promise((e,n)=>{this.pendingTickets[t]=((i,r)=>{i||!r?(delete this.pendingTickets[t],e(i)):n(r)})});return{uuid:t,answer:n}}),this.answer=((e,t,n=!1)=>{if(!n&&!this.hasUUID(e))throw new s(`no pending ticket for uuid="${e}"`,e);const i=this.pendingTickets[e];delete this.pendingTickets[e],i(t)}),this.pendingTickets={},this.hasUUID=(e=>e in this.pendingTickets),this.rejectTicket=((e,t=!1)=>{if(!this.hasUUID(e))return;const n=this.pendingTickets[e];if(delete this.pendingTickets[e],"ignore errors"===t)try{n(void 0,o.TICKET_REJECTED)}catch(i){}else n(void 0,o.TICKET_REJECTED)}),this.nextUUID=(()=>{let e=0;return()=>{e>=Number.MAX_SAFE_INTEGER-5&&(e=0);do{e++}while(this.hasUUID(e));return e}})()}}o.TICKET_REJECTED=Symbol("TICKET_REJECTED"),r.TicketList=o;var a={};Object.defineProperty(a,"__esModule",{value:!0}),a.asReadableStream=function(e){return e},a.asWritableStream=function(e){return e},a.asDuplexStream=function(e){return e};var u={},c=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(r,s){function o(e){try{u(i.next(e))}catch(t){s(t)}}function a(e){try{u(i.throw(e))}catch(t){s(t)}}function u(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(o,a)}u((i=i.apply(e,t||[])).next())})};Object.defineProperty(u,"__esModule",{value:!0}),u.StreamTransport=class{constructor(e,n,i=t.DefaultConfig,s=""){this.debugName=s,this.config=t.DefaultConfig,this.pending=new r.TicketList,this.rstream=a.asReadableStream(e),this.wstream=a.asWritableStream(n),this.setConfig(i),this.rstream.on("data",e=>c(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${s} onData: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${s} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${s} wrong message type`);if(this.pending.hasUUID(e.uuid))this.config.debug&&console.log(`StreamIOTransport_${s}: found pending, answering pending ticket uuid="${e.uuid}"`),this.pending.answer(e.uuid,e,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${s}: no pending ticket with this uuid="${e.uuid}", calling requestHandler`);const t=yield this.requestHandler(e.data);this.config.debug&&console.log(`StreamIOTransport_${s}: requestHandler for uuid="${e.uuid}", answered data: "${JSON.stringify(t)}"`),this.wstream.write({uuid:e.uuid,data:t})}}))}request(e){const t=this.pending.nextUUID(),n={uuid:t,data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request with uuid="${t}", data="${JSON.stringify(e)}", new pending ticket`);const{answer:i}=this.pending.ask(n.uuid);return this.wstream.write(n),i.then(e=>e.data)}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var d={};Object.defineProperty(d,"__esModule",{value:!0}),d.asTypedEventEmitter=function(e){return e};var l={};Object.defineProperty(l,"__esModule",{value:!0});var h=function(){var e=this;this.events={},this.maxListeners=1/0,this.emit=function(t){for(var n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(e.events[t]){for(var r=0,s=e.events[t];r<s.length;r++)s[r].apply(void 0,n);return!!e.events[t].length}return!1},this.on=function(t,n){return e.addListener(t,n),e},this.once=function(t,n){return e.addListener(t,function(){for(var i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];n.apply(void 0,i),e.removeListener(t,n)}),e},this.addListener=function(t,n){return t in e.events?e.events[t].push(n):e.events[t]=[n],e.maxListeners!==1/0&&e.maxListeners<=e.events[t].length&&console.warn('Maximum event listeners for "'+t+'" event!'),e},this.removeListener=function(t,n){if(t in e.events){var i=e.events[t].indexOf(n);-1!==i&&e.events[t].splice(i,1)}return e},this.hasListeners=function(t){return e.events[t]&&!!e.events[t].length},this.prependListener=function(t,n){return t in e.events?e.events[t].unshift(n):e.events[t]=[n],e},this.prependOnceListener=function(t,n){return e.prependListener(t,function(){for(var i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];n.apply(void 0,i),e.removeListener(t,n)}),e},this.off=function(t,n){return e.removeListener(t,n)},this.removeAllListeners=function(t){return delete e.events[t],e},this.setMaxListeners=function(t){return e.maxListeners=t,e},this.getMaxListeners=function(){return e.maxListeners},this.listeners=function(t){return e.events[t].slice()},this.rawListeners=function(t){return e.events[t]},this.eventNames=function(){return Object.keys(e.events)},this.listenerCount=function(t){return e.events[t]&&e.events[t].length||0}};l.EventEmitter=h;var f={};function g(e){for(var t in e)f.hasOwnProperty(t)||(f[t]=e[t])}Object.defineProperty(f,"__esModule",{value:!0}),g(d),g(l);var p={},m=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(p,"__esModule",{value:!0});const v=m(f);function b(e){try{const n=JSON.parse(e.data);if("object"==typeof n&&"_$_rpct-window-stream_$_"===n.type&&"payload"in n)return n.payload}catch(t){}return p.WINDOW_STREAM_DATA_FAIL}function w(e){const t={type:"_$_rpct-window-stream_$_",payload:e};return JSON.stringify(t)}function _(e={}){const{unpack:t=b}=e,n=new v.EventEmitter;return{stream:n,handler:e=>{const i=t(e);i!==p.WINDOW_STREAM_DATA_FAIL&&n.emit("data",i)}}}p.WINDOW_STREAM_DATA_FAIL=Symbol("WINDOW_STREAM_DATA_FAIL"),p.defaultWindowStreamDataUnpacker=b,p.defaultWindowStreamDataPacker=w,p.createWindowReadStream=function(e,t={}){const{stream:n,handler:i}=_(t);return e.addEventListener("message",i),{stream:n,disposer:()=>{e.removeEventListener("message",i)}}},p.createWindowReadStreamHandler=_;class y extends v.EventEmitter{constructor(e,t){super(),this.window=e,this.opts=t,this.packer=t.pack||w,this.targetOrigin=t.targetOrigin||"*"}write(e,t,n){"function"==typeof t&&(n=t);const i=this.packer(e);return this.window.postMessage(i,this.targetOrigin),n&&n(),!0}}p.WindowWriteStream=y,p.createWindowWriteStream=function(e,t={}){return new y(e,t)};var k={},O=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(r,s){function o(e){try{u(i.next(e))}catch(t){s(t)}}function a(e){try{u(i.throw(e))}catch(t){s(t)}}function u(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(o,a)}u((i=i.apply(e,t||[])).next())})};Object.defineProperty(k,"__esModule",{value:!0}),k.DuplexJsonStreamTransport=class{constructor(e,n=t.DefaultConfig,i=""){this.debugName=i,this.config=t.DefaultConfig,this.pending=new r.TicketList,this.setConfig(n),this.stream=e,e.on("data",e=>O(this,void 0,void 0,function*(){let t;t=e instanceof Uint8Array?e.toString():"object"==typeof e?e:`${e}`,this.config.debug&&console.log(`StreamIOTransport_${i} received message: "${t}"`);let n=e;try{"string"==typeof t&&(n=JSON.parse(t))}catch(r){throw r}if("object"!=typeof n)throw new Error(`StreamIOTransport_${i} wrong message type; should be object`);if(!Object.keys(n).includes("uuid"))throw new Error(`StreamIOTransport_${i} wrong message type; should have uuid`);if(this.pending.hasUUID(n.uuid))this.config.debug&&console.log(`StreamIOTransport_${i}: found pending`,n.uuid),this.pending.answer(n.uuid,n,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${i}: forEach requestHandler`);const e=yield this.requestHandler(n.data);this.stream.write(JSON.stringify({uuid:n.uuid,data:e}))}}))}request(e){const t={uuid:this.pending.nextUUID(),data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(JSON.stringify(t)),n}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var S={},T=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(r,s){function o(e){try{u(i.next(e))}catch(t){s(t)}}function a(e){try{u(i.throw(e))}catch(t){s(t)}}function u(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(o,a)}u((i=i.apply(e,t||[])).next())})};Object.defineProperty(S,"__esModule",{value:!0}),S.DuplexStreamTransport=class{constructor(e,n=t.DefaultConfig,i=""){this.debugName=i,this.config=t.DefaultConfig,this.pending=new r.TicketList,this.setConfig(n),this.stream=e,e.on("data",e=>T(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${i} received message: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${i} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${i} wrong message type`);if(this.pending.hasUUID(e.uuid))this.config.debug&&console.log(`StreamIOTransport_${i}: found pending`,e.uuid),this.pending.answer(e.uuid,e,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${i}: forEach requestHandler`);const t=yield this.requestHandler(e.data);this.stream.write({uuid:e.uuid,data:t})}}))}request(e){const t={uuid:this.pending.nextUUID(),data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(t),n}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var $={};function I(e){for(var t in e)$.hasOwnProperty(t)||($[t]=e[t])}Object.defineProperty($,"__esModule",{value:!0}),I(n),I(t),I(k),I(S),I(u),I(a),I(r),I(e),I(p),I(f);var E={},D=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(E,"__esModule",{value:!0});const U=D(f);E.FigmaPluginWriteStream=class extends U.EventEmitter{constructor(e){super(),this.figma=e}write(e,t,n){return"function"==typeof t&&(n=t),this.figma.ui.postMessage(e),n&&n(),!0}};var N={};function x(e){for(var t in e)N.hasOwnProperty(t)||(N[t]=e[t])}return Object.defineProperty(N,"__esModule",{value:!0}),x($),x(E),N.connectToPlugin=function(e){const t=p.createWindowReadStream(window,{unpack:e=>e.data.pluginMessage}).stream,i=p.createWindowWriteStream(parent,{pack:e=>({pluginMessage:e})}),r=new u.StreamTransport(t,i,void 0,"plugin ui");return new n.Api(e,r)},N.connectToUI=function(e,t){const i=new E.FigmaPluginWriteStream(e),r=new f.EventEmitter;e.ui.onmessage=(e=>{r.emit("data",e)});const s=new u.StreamTransport(r,i,void 0,"plugin back");return new n.Api(t,s)},N});