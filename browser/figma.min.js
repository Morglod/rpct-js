!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).RPCT=e()}}(function(){var e=function(e){var t;return function(n){return t||e(t={exports:{},parent:n},t.exports),t.exports}},t=e(function(e,t){"use strict";var r=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(i,r){function s(e){try{u(o.next(e))}catch(t){r(t)}}function a(e){try{u(o.throw(e))}catch(t){r(t)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,a)}u((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const s=n({});var a;!function(e){e[e.none=0]="none",e[e.value=1]="value",e[e.callback=2]="callback",e[e.proxy=4]="proxy",e[e.extension=65536]="extension"}(a=t.ApiProtocolArgTypeFlag||(t.ApiProtocolArgTypeFlag={})),t.Api=class{constructor(e,t,n={}){this.handleRemoteCall=(e=>r(this,void 0,void 0,function*(){const t=this.requestCounter();this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: "${JSON.stringify(e)}" rid=${t}`);const n=e;let o;if(!n)throw new Error("Api: handleRemoteCall failed, undefined data");this._hook_preHandleRemoteCall(n,t);const i=this._hook_handleRemoteCallPickMethod(n,t);if(i)o=i;else{if(!n.method)return console.error("not method & not callback"),{data:void 0,exception:"not method & not callback"};if(!this.methods||!this.methods[n.method])return console.error(`method '${n.method}' not found`),{data:void 0,exception:`method '${n.method}' not found`};this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: found selfMethod data.method="${n.method}"`),o=this.methods[n.method]}this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: processing data.args`);const r=n.args.map((e,n)=>{return this._hook_unpackArg(e,n,t)||(e.type===a.callback?(this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: callback at ${n} arg index, returning proxy`),(...t)=>(this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: proxy call for ${n} arg index, callbackArgs="${JSON.stringify(t)}", callback="${e.callback}"`),this._call({callback:e.callback,args:t}))):e.type===a.value?e.value:void 0)});this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: invoking func`);try{const e=yield o(...r);return this._hook_postHandleRemoteCall(t),{data:this._hook_packReturnValue(e,t)||e}}catch(s){return{data:void 0,exception:`${s}`}}})),this._call=(e=>r(this,void 0,void 0,function*(){const t=this.requestCounter();this.config.debug&&console.log(`Api_${this.debugName} call: params="${JSON.stringify(e)}" rid=${t}`),this._hook_call(e,t);const n={method:e.method,callback:e.callback,args:e.args.map((e,n)=>{return this._hook_packArg(e,n,t)||{type:a.value,value:e}})};this.config.debug&&console.log(`Api_${this.debugName} call: sending request to transport`);const o=yield this.transport.request(n);if(this._hook_postCall(e,t),o.exception)throw o.exception;return this._hook_unpackReturnValue(o.data,t)||o.data})),this.callMethod=((e,...t)=>this._call({method:e,args:t})),this.call=((e,...t)=>this._call({method:e,args:t})),this.requestCounter=o.simpleCountGenerator(),this.hooks=u.reduce((e,t)=>Object.assign(e,{[t]:[]}),{}),this._hook_call=((e,t)=>{if(0===this.hooks.call.length)return;const n=Object.assign({},e,{args:[...e.args]});for(const o of this.hooks.call)o(e,n,t)}),this._hook_postCall=((e,t)=>{if(0!==this.hooks.postCall.length)for(const n of this.hooks.postCall)n(e,t)}),this._hook_preHandleRemoteCall=((e,t)=>{if(0!==this.hooks.preHandleRemoteCall.length)for(const n of this.hooks.preHandleRemoteCall)n(e,t)}),this._hook_handleRemoteCallPickMethod=((e,t)=>{if(0===this.hooks.handleRemoteCallPickMethod.length)return;let n;for(const o of this.hooks.handleRemoteCallPickMethod)n=o(n,e,t);return n}),this._hook_postHandleRemoteCall=(e=>{if(0!==this.hooks.postHandleRemoteCall.length)for(const t of this.hooks.postHandleRemoteCall)t(e)}),this._hook_packArg=((e,t,n)=>{if(0===this.hooks.packArg.length)return;let o=void 0;for(const i of this.hooks.packArg)o=i(o,e,t,n);return o}),this._hook_unpackArg=((e,t,n)=>{if(0===this.hooks.unpackArg.length)return;let o=void 0;for(const i of this.hooks.unpackArg)o=i(o,e,t,n);return o}),this._hook_packReturnValue=((e,t)=>{if(0===this.hooks.packReturnValue.length)return e;let n=void 0;for(const o of this.hooks.packReturnValue)n=o(n,e,t);return n}),this._hook_unpackReturnValue=((e,t)=>{if(0===this.hooks.unpackReturnValue.length)return e;let n=void 0;for(const o of this.hooks.unpackReturnValue)n=o(n,e,t);return n}),this.addMiddleware=(e=>r(this,void 0,void 0,function*(){e.install&&e.install.call(e,this,e);for(const t of u)e[t]&&this.hooks[t].push(e[t].bind(e))}));const{config:l=i.DefaultConfig,debugName:c="",middlewares:d=[s.callbacksMiddleware().middleware]}=n;this.nextUUID=l.uuidGeneratorFactory(),this.methods=e,this.transport=t,this.config=l,this.debugName=c,t.setRequestHandler(this.handleRemoteCall);for(const o of d)this.addMiddleware(o)}};const u=["call","postCall","preHandleRemoteCall","handleRemoteCallPickMethod","postHandleRemoteCall","packArg","unpackArg","packReturnValue","unpackReturnValue"]}),n=e(function(e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=t({});n.callbacksMiddleware=(()=>{const e={},t={};let n;return{middleware:{install(e){n=e},postCall(n,o){if(e[o]){for(const n of e[o])delete t[n];delete e[o]}},packArg(i,r,s,a){if("function"==typeof r){const i=`${n.nextUUID()}`;return e[a]||(e[a]=[]),e[a].push(i),t[i]=r,n.config.debug&&console.log(`Api_${n.debugName} call: found func arg at ${s} index, bound a callback as callbackUUID="${i}"`),{type:o.ApiProtocolArgTypeFlag.callback,callback:i}}},handleRemoteCallPickMethod(e,o,i){if(o.callback)return n.config.debug&&console.log(`Api_${n.debugName} handleRemoteCall: it has a callback call request data.callback="${o.callback}"`),t[o.callback]?(n.config.debug&&console.log(`Api_${n.debugName} handleRemoteCall: found callback="${o.callback}"`),t[o.callback]):void console.error(`callback '${o.method}' not found`)}},freeCallback:e=>{const n=Object.entries(t).find(([,t])=>t===e);if(n){const[e]=n;delete t[e]}}}})}),o={};Object.defineProperty(o,"__esModule",{value:!0}),o.cloneJSON=function(e){return JSON.parse(JSON.stringify(e))},o.simpleCountGenerator=function(e=0){let t=e;return()=>(t>=Number.MAX_SAFE_INTEGER-5&&(t=0),++t)},o.unsafeUUIDGenerator=function(){return()=>`${Date.now()}-${Math.floor(9999*Math.random()).toString(16)}-${Math.floor(9999*Math.random()).toString(16)}`};var i={};Object.defineProperty(i,"__esModule",{value:!0}),i.DefaultConfig={version:"0.1.0",debug:!1,uuidGeneratorFactory:o.unsafeUUIDGenerator};var r={};Object.defineProperty(r,"__esModule",{value:!0});class s extends Error{constructor(e,t){super(e),this.uuid=t}}class a{constructor(){this.ask=(e=>{const t=null===e?this.nextUUID():e,n=new Promise((e,n)=>{this.pendingTickets[t]=((o,i)=>{o||!i?(delete this.pendingTickets[t],e(o)):n(i)})});return{uuid:t,answer:n}}),this.answer=((e,t,n=!1)=>{if(!n&&!this.hasUUID(e))throw new s(`no pending ticket for uuid="${e}"`,e);const o=this.pendingTickets[e];delete this.pendingTickets[e],o(t)}),this.pendingTickets={},this.hasUUID=(e=>e in this.pendingTickets),this.rejectTicket=((e,t=!1)=>{if(!this.hasUUID(e))return;const n=this.pendingTickets[e];if(delete this.pendingTickets[e],"ignore errors"===t)try{n(void 0,a.TICKET_REJECTED)}catch(o){}else n(void 0,a.TICKET_REJECTED)}),this.nextUUID=(()=>{let e=0;return()=>{e>=Number.MAX_SAFE_INTEGER-5&&(e=0);do{e++}while(this.hasUUID(e));return e}})()}}a.TICKET_REJECTED=Symbol("TICKET_REJECTED"),r.TicketList=a;var u={},l=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(i,r){function s(e){try{u(o.next(e))}catch(t){r(t)}}function a(e){try{u(o.throw(e))}catch(t){r(t)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,a)}u((o=o.apply(e,t||[])).next())})};Object.defineProperty(u,"__esModule",{value:!0}),u.DuplexJsonStreamTransport=class{constructor(e,t=i.DefaultConfig,n=""){this.debugName=n,this.config=i.DefaultConfig,this.pending=new r.TicketList,this.setConfig(t),this.stream=e,e.on("data",e=>l(this,void 0,void 0,function*(){let t;t=e instanceof Uint8Array?e.toString():"object"==typeof e?e:`${e}`,this.config.debug&&console.log(`StreamIOTransport_${n} received message: "${t}"`);let o=e;try{"string"==typeof t&&(o=JSON.parse(t))}catch(i){throw i}if("object"!=typeof o)throw new Error(`StreamIOTransport_${n} wrong message type; should be object`);if(!Object.keys(o).includes("uuid"))throw new Error(`StreamIOTransport_${n} wrong message type; should have uuid`);if(this.pending.hasUUID(o.uuid))this.config.debug&&console.log(`StreamIOTransport_${n}: found pending`,o.uuid),this.pending.answer(o.uuid,o,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${n}: forEach requestHandler`);const e=yield this.requestHandler(o.data);this.stream.write(JSON.stringify(Object.assign(e,{uuid:o.uuid})))}}))}request(e){const t={uuid:this.pending.nextUUID(),data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(JSON.stringify(t)),n.catch(e=>({data:void 0,exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var c={},d=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(i,r){function s(e){try{u(o.next(e))}catch(t){r(t)}}function a(e){try{u(o.throw(e))}catch(t){r(t)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,a)}u((o=o.apply(e,t||[])).next())})};Object.defineProperty(c,"__esModule",{value:!0}),c.DuplexStreamTransport=class{constructor(e,t=i.DefaultConfig,n=""){this.debugName=n,this.config=i.DefaultConfig,this.pending=new r.TicketList,this.setConfig(t),this.stream=e,e.on("data",e=>d(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${n} received message: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${n} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${n} wrong message type`);if(this.pending.hasUUID(e.uuid))this.config.debug&&console.log(`StreamIOTransport_${n}: found pending`,e.uuid),this.pending.answer(e.uuid,e,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${n}: forEach requestHandler`);const t=yield this.requestHandler(e.data);this.stream.write(Object.assign(t,{uuid:e.uuid}))}}))}request(e){const t={uuid:this.pending.nextUUID(),data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(t),n.catch(e=>({data:void 0,exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var h={};Object.defineProperty(h,"__esModule",{value:!0}),h.asReadableStream=function(e){return e},h.asWritableStream=function(e){return e},h.asDuplexStream=function(e){return e};var f={},g=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(i,r){function s(e){try{u(o.next(e))}catch(t){r(t)}}function a(e){try{u(o.throw(e))}catch(t){r(t)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,a)}u((o=o.apply(e,t||[])).next())})};Object.defineProperty(f,"__esModule",{value:!0}),f.StreamTransport=class{constructor(e,t,n=i.DefaultConfig,o=""){this.debugName=o,this.config=i.DefaultConfig,this.pending=new r.TicketList,this.rstream=h.asReadableStream(e),this.wstream=h.asWritableStream(t),this.setConfig(n),this.rstream.on("data",e=>g(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${o} onData: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${o} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${o} wrong message type`);if(this.pending.hasUUID(e.uuid))this.config.debug&&console.log(`StreamIOTransport_${o}: found pending, answering pending ticket uuid="${e.uuid}"`),this.pending.answer(e.uuid,e,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${o}: no pending ticket with this uuid="${e.uuid}", calling requestHandler`);const t=yield this.requestHandler(e.data);this.config.debug&&console.log(`StreamIOTransport_${o}: requestHandler for uuid="${e.uuid}", answered data: "${JSON.stringify(t)}"`),this.wstream.write(Object.assign(t,{uuid:e.uuid}))}}))}request(e){const t=this.pending.nextUUID(),n={uuid:t,data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request with uuid="${t}", data="${JSON.stringify(e)}", new pending ticket`);const{answer:o}=this.pending.ask(n.uuid);return this.wstream.write(n),o.catch(e=>({data:void 0,exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var p={};Object.defineProperty(p,"__esModule",{value:!0}),p.asTypedEventEmitter=function(e){return e};var m={};Object.defineProperty(m,"__esModule",{value:!0});var _=function(){var e=this;this.events={},this.maxListeners=1/0,this.emit=function(t){for(var n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];if(e.events[t]){for(var i=0,r=e.events[t];i<r.length;i++)r[i].apply(void 0,n);return!!e.events[t].length}return!1},this.on=function(t,n){return e.addListener(t,n),e},this.once=function(t,n){return e.addListener(t,function(){for(var o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];n.apply(void 0,o),e.removeListener(t,n)}),e},this.addListener=function(t,n){return t in e.events?e.events[t].push(n):e.events[t]=[n],e.maxListeners!==1/0&&e.maxListeners<=e.events[t].length&&console.warn('Maximum event listeners for "'+t+'" event!'),e},this.removeListener=function(t,n){if(t in e.events){var o=e.events[t].indexOf(n);-1!==o&&e.events[t].splice(o,1)}return e},this.hasListeners=function(t){return e.events[t]&&!!e.events[t].length},this.prependListener=function(t,n){return t in e.events?e.events[t].unshift(n):e.events[t]=[n],e},this.prependOnceListener=function(t,n){return e.prependListener(t,function(){for(var o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];n.apply(void 0,o),e.removeListener(t,n)}),e},this.off=function(t,n){return e.removeListener(t,n)},this.removeAllListeners=function(t){return delete e.events[t],e},this.setMaxListeners=function(t){return e.maxListeners=t,e},this.getMaxListeners=function(){return e.maxListeners},this.listeners=function(t){return e.events[t].slice()},this.rawListeners=function(t){return e.events[t]},this.eventNames=function(){return Object.keys(e.events)},this.listenerCount=function(t){return e.events[t]&&e.events[t].length||0}};m.EventEmitter=_;var v={};function k(e){for(var t in e)v.hasOwnProperty(t)||(v[t]=e[t])}Object.defineProperty(v,"__esModule",{value:!0}),k(p),k(m);var b={},w=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(b,"__esModule",{value:!0});const y=w(v);function O(e){try{const n=JSON.parse(e.data);if("object"==typeof n&&"_$_rpct-window-stream_$_"===n.type&&"payload"in n)return n.payload}catch(t){}return b.WINDOW_STREAM_DATA_FAIL}function $(e){const t={type:"_$_rpct-window-stream_$_",payload:e};return JSON.stringify(t)}function S(e={}){const{unpack:t=O}=e,n=new y.EventEmitter;return{stream:n,handler:e=>{const o=t(e);o!==b.WINDOW_STREAM_DATA_FAIL&&n.emit("data",o)}}}b.WINDOW_STREAM_DATA_FAIL=Symbol("WINDOW_STREAM_DATA_FAIL"),b.defaultWindowStreamDataUnpacker=O,b.defaultWindowStreamDataPacker=$,b.createWindowReadStream=function(e,t={}){const{stream:n,handler:o}=S(t);return e.addEventListener("message",o),{stream:n,disposer:()=>{e.removeEventListener("message",o)}}},b.createWindowReadStreamHandler=S;class T extends y.EventEmitter{constructor(e,t){super(),this.window=e,this.opts=t,this.packer=t.pack||$,this.targetOrigin=t.targetOrigin||"*"}write(e,t,n){"function"==typeof t&&(n=t);const o=this.packer(e);return this.window.postMessage(o,this.targetOrigin),n&&n(),!0}}b.WindowWriteStream=T,b.createWindowWriteStream=function(e,t={}){return new T(e,t)};var C={};function R(e){for(var t in e)C.hasOwnProperty(t)||(C[t]=e[t])}Object.defineProperty(C,"__esModule",{value:!0}),R(t({})),R(i),R(u),R(c),R(f),R(o),R(b),R(h),R(v);var x={};Object.defineProperty(x,"__esModule",{value:!0}),x.FigmaPluginWriteStream=class extends v.EventEmitter{constructor(e){super(),this.figma=e}write(e,t,n){return"function"==typeof t&&(n=t),this.figma.ui.postMessage(e),n&&n(),!0}};var A={};Object.defineProperty(A,"__esModule",{value:!0});const I=t({});A.connectToPlugin=function(e){const t=b.createWindowReadStream(window,{unpack:e=>e.data.pluginMessage}).stream,n=b.createWindowWriteStream(parent,{pack:e=>({pluginMessage:e})}),o=new f.StreamTransport(t,n,void 0,"plugin ui");return new I.Api(e,o)},A.connectToUI=function(e,t){const n=new x.FigmaPluginWriteStream(e),o=new v.EventEmitter;e.ui.onmessage=(e=>{o.emit("data",e)});const i=new f.StreamTransport(o,n,void 0,"plugin back");return new I.Api(t,i)};var E={};function D(e){for(var t in e)E.hasOwnProperty(t)||(E[t]=e[t])}return Object.defineProperty(E,"__esModule",{value:!0}),D(C),D(x),D(A),E});