!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).RPCT=e()}}(function(){var e=function(e){var t;return function(n){return t||e(t={exports:{},parent:n},t.exports),t.exports}},t=e(function(e,t){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{l(i.next(e))}catch(t){s(t)}}function a(e){try{l(i.throw(e))}catch(t){s(t)}}function l(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(r,a)}l((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const s=n({});var r;!function(e){e[e.none=0]="none",e[e.value=1]="value",e[e.callback=2]="callback",e[e.extension=65536]="extension"}(r=t.ApiProtocolArgTypeFlag||(t.ApiProtocolArgTypeFlag={})),t.Api=class{constructor(e,t,n={}){this.handleRemoteCall=(e=>{const t=this.requestCounter();this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: "${JSON.stringify(e)}" rid=${t}`);const n=e;let i;if(!n)throw new Error("Api: handleRemoteCall failed, undefined data");this._hook_preHandleRemoteCall(n,t);const o=this._hook_handleRemoteCallPickMethod(n,t);if(o)i=o;else{if(!n.method)return void console.error("not method & not callback");if(!this.methods||!this.methods[n.method])return void console.error(`method '${n.method}' not found`);this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: found selfMethod data.method="${n.method}"`),i=this.methods[n.method]}this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: processing data.args`);const s=n.args.map((e,n)=>{return this._hook_unpackArg(e,n,t)||(e.type===r.callback?(this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: callback at ${n} arg index, returning proxy`),(...t)=>(this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: proxy call for ${n} arg index, callbackArgs="${JSON.stringify(t)}", callback="${e.callback}"`),this._call({callback:e.callback,args:t}))):e.type===r.value?e.value:void 0)});this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: invoking func`);const a=i(...s);return this._hook_postHandleRemoteCall(t),this._hook_packReturnValue(a,t)||a}),this._call=(e=>i(this,void 0,void 0,function*(){const t=this.requestCounter();this.config.debug&&console.log(`Api_${this.debugName} call: params="${JSON.stringify(e)}" rid=${t}`),this._hook_call(e,t);const n={method:e.method,callback:e.callback,args:e.args.map((e,n)=>{return this._hook_packArg(e,n,t)||{type:r.value,value:e}})};this.config.debug&&console.log(`Api_${this.debugName} call: sending request to transport`);const i=yield this.transport.request(n);return this._hook_postCall(e,t),this._hook_unpackReturnValue(i,t)||i})),this.callMethod=((e,...t)=>this._call({method:e,args:t})),this.call=((e,...t)=>this._call({method:e,args:t})),this.requestCounter=(()=>{let e=0;return()=>e++})(),this.hooks=a.reduce((e,t)=>Object.assign(e,{[t]:[]}),{}),this._hook_call=((e,t)=>{if(0===this.hooks.call.length)return;const n=Object.assign({},e,{args:[...e.args]});for(const i of this.hooks.call)i(e,n,t)}),this._hook_postCall=((e,t)=>{if(0!==this.hooks.postCall.length)for(const n of this.hooks.postCall)n(e,t)}),this._hook_preHandleRemoteCall=((e,t)=>{if(0!==this.hooks.preHandleRemoteCall.length)for(const n of this.hooks.preHandleRemoteCall)n(e,t)}),this._hook_handleRemoteCallPickMethod=((e,t)=>{if(0===this.hooks.handleRemoteCallPickMethod.length)return;let n;for(const i of this.hooks.handleRemoteCallPickMethod)n=i(n,e,t);return n}),this._hook_postHandleRemoteCall=(e=>{if(0!==this.hooks.postHandleRemoteCall.length)for(const t of this.hooks.postHandleRemoteCall)t(e)}),this._hook_packArg=((e,t,n)=>{if(0===this.hooks.packArg.length)return;let i=void 0;for(const o of this.hooks.packArg)i=o(i,e,t,n);return i}),this._hook_unpackArg=((e,t,n)=>{if(0===this.hooks.unpackArg.length)return;let i=void 0;for(const o of this.hooks.unpackArg)i=o(i,e,t,n);return i}),this._hook_packReturnValue=((e,t)=>{if(0===this.hooks.packReturnValue.length)return;let n=void 0;for(const i of this.hooks.packReturnValue)n=i(n,e,t);return n}),this._hook_unpackReturnValue=((e,t)=>{if(0===this.hooks.unpackReturnValue.length)return;let n=void 0;for(const i of this.hooks.unpackReturnValue)n=i(n,e,t);return n}),this.addMiddleware=(e=>i(this,void 0,void 0,function*(){e.install&&e.install.call(e,this,e);for(const t of a)e[t]&&this.hooks[t].push(e[t].bind(e))}));const{config:l=o.DefaultConfig,debugName:u="",middlewares:c=[s.callbacksMiddleware()]}=n;this.nextUUID=l.uuidGeneratorFactory(),this.methods=e,this.transport=t,this.config=l,this.debugName=u,t.setRequestHandler(this.handleRemoteCall);for(const i of c)this.addMiddleware(i)}};const a=["call","postCall","preHandleRemoteCall","handleRemoteCallPickMethod","postHandleRemoteCall","packArg","unpackArg","packReturnValue","unpackReturnValue"]}),n=e(function(e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const i=t({});n.callbacksMiddleware=(()=>({callBoundCallbacks:{},callbacks:{},api:void 0,install(e){this.api=e,this.callbacks={}},call(e,t,n){},postCall(e,t){if(this.callBoundCallbacks[t]){for(const e of this.callBoundCallbacks[t])delete this.callbacks[e];delete this.callBoundCallbacks[t]}},packArg(e,t,n,o){if("function"==typeof t){const e=`${this.api.nextUUID()}`;return this.callBoundCallbacks[o]||(this.callBoundCallbacks[o]=[]),this.callBoundCallbacks[o].push(e),this.callbacks[e]=t,this.api.config.debug&&console.log(`Api_${this.api.debugName} call: found func arg at ${n} index, bound a callback as callbackUUID="${e}"`),{type:i.ApiProtocolArgTypeFlag.callback,callback:e}}},handleRemoteCallPickMethod(e,t,n){if(t.callback)return this.api.config.debug&&console.log(`Api_${this.api.debugName} handleRemoteCall: it has a callback call request data.callback="${t.callback}"`),this.callbacks[t.callback]?(this.api.config.debug&&console.log(`Api_${this.api.debugName} handleRemoteCall: found callback="${t.callback}"`),this.callbacks[t.callback]):void console.error(`callback '${t.method}' not found`)}}))}),i={};Object.defineProperty(i,"__esModule",{value:!0}),i.cloneJSON=function(e){return JSON.parse(JSON.stringify(e))},i.simpleCountGenerator=function(){let e=0;return()=>(e>=Number.MAX_SAFE_INTEGER-5&&(e=0),++e)},i.unsafeUUIDGenerator=function(){return()=>`${Date.now()}-${Math.floor(9999*Math.random()).toString(16)}-${Math.floor(9999*Math.random()).toString(16)}`};var o={};Object.defineProperty(o,"__esModule",{value:!0}),o.DefaultConfig={version:"0.1.0",debug:!1,uuidGeneratorFactory:i.unsafeUUIDGenerator};var s={};Object.defineProperty(s,"__esModule",{value:!0});class r extends Error{constructor(e,t){super(e),this.uuid=t}}s.TicketListAnswerError=r;class a{constructor(){this.ask=(e=>{const t=null===e?this.nextUUID():e,n=new Promise((e,n)=>{this.pendingTickets[t]=((i,o)=>{i||!o?(delete this.pendingTickets[t],e(i)):n(o)})});return{uuid:t,answer:n}}),this.answer=((e,t,n=!1)=>{if(!n&&!this.hasUUID(e))throw new r(`no pending ticket for uuid="${e}"`,e);const i=this.pendingTickets[e];delete this.pendingTickets[e],i(t)}),this.pendingTickets={},this.hasUUID=(e=>e in this.pendingTickets),this.rejectTicket=((e,t=!1)=>{if(!this.hasUUID(e))return;const n=this.pendingTickets[e];if(delete this.pendingTickets[e],"ignore errors"===t)try{n(void 0,a.TICKET_REJECTED)}catch(i){}else n(void 0,a.TICKET_REJECTED)}),this.nextUUID=(()=>{let e=0;return()=>{e>=Number.MAX_SAFE_INTEGER-5&&(e=0);do{e++}while(this.hasUUID(e));return e}})()}}a.TICKET_REJECTED=Symbol("TICKET_REJECTED"),s.TicketList=a;var l={};Object.defineProperty(l,"__esModule",{value:!0}),l.asReadableStream=function(e){return e},l.asWritableStream=function(e){return e},l.asDuplexStream=function(e){return e};var u={},c=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{l(i.next(e))}catch(t){s(t)}}function a(e){try{l(i.throw(e))}catch(t){s(t)}}function l(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(r,a)}l((i=i.apply(e,t||[])).next())})};Object.defineProperty(u,"__esModule",{value:!0}),u.StreamTransport=class{constructor(e,t,n=o.DefaultConfig,i=""){this.debugName=i,this.config=o.DefaultConfig,this.pending=new s.TicketList,this.rstream=l.asReadableStream(e),this.wstream=l.asWritableStream(t),this.setConfig(n),this.rstream.on("data",e=>c(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${i} onData: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${i} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${i} wrong message type`);if(this.pending.hasUUID(e.uuid))this.config.debug&&console.log(`StreamIOTransport_${i}: found pending, answering pending ticket uuid="${e.uuid}"`),this.pending.answer(e.uuid,e,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${i}: no pending ticket with this uuid="${e.uuid}", calling requestHandler`);const t=yield this.requestHandler(e.data);this.config.debug&&console.log(`StreamIOTransport_${i}: requestHandler for uuid="${e.uuid}", answered data: "${JSON.stringify(t)}"`),this.wstream.write({uuid:e.uuid,data:t})}}))}request(e){const t=this.pending.nextUUID(),n={uuid:t,data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request with uuid="${t}", data="${JSON.stringify(e)}", new pending ticket`);const{answer:i}=this.pending.ask(n.uuid);return this.wstream.write(n),i.then(e=>e.data)}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var d={};Object.defineProperty(d,"__esModule",{value:!0}),d.asTypedEventEmitter=function(e){return e};var h={};Object.defineProperty(h,"__esModule",{value:!0});var f=function(){var e=this;this.events={},this.maxListeners=1/0,this.emit=function(t){for(var n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(e.events[t]){for(var o=0,s=e.events[t];o<s.length;o++)s[o].apply(void 0,n);return!!e.events[t].length}return!1},this.on=function(t,n){return e.addListener(t,n),e},this.once=function(t,n){return e.addListener(t,function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];n.apply(void 0,i),e.removeListener(t,n)}),e},this.addListener=function(t,n){return t in e.events?e.events[t].push(n):e.events[t]=[n],e.maxListeners!==1/0&&e.maxListeners<=e.events[t].length&&console.warn('Maximum event listeners for "'+t+'" event!'),e},this.removeListener=function(t,n){if(t in e.events){var i=e.events[t].indexOf(n);-1!==i&&e.events[t].splice(i,1)}return e},this.hasListeners=function(t){return e.events[t]&&!!e.events[t].length},this.prependListener=function(t,n){return t in e.events?e.events[t].unshift(n):e.events[t]=[n],e},this.prependOnceListener=function(t,n){return e.prependListener(t,function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];n.apply(void 0,i),e.removeListener(t,n)}),e},this.off=function(t,n){return e.removeListener(t,n)},this.removeAllListeners=function(t){return delete e.events[t],e},this.setMaxListeners=function(t){return e.maxListeners=t,e},this.getMaxListeners=function(){return e.maxListeners},this.listeners=function(t){return e.events[t].slice()},this.rawListeners=function(t){return e.events[t]},this.eventNames=function(){return Object.keys(e.events)},this.listenerCount=function(t){return e.events[t]&&e.events[t].length||0}};h.EventEmitter=f;var g={};function p(e){for(var t in e)g.hasOwnProperty(t)||(g[t]=e[t])}Object.defineProperty(g,"__esModule",{value:!0}),p(d),p(h);var m={},k=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(m,"__esModule",{value:!0});const _=k(g);function v(e){try{const n=JSON.parse(e.data);if("object"==typeof n&&"_$_rpct-window-stream_$_"===n.type&&"payload"in n)return n.payload}catch(t){}return m.WINDOW_STREAM_DATA_FAIL}function b(e){const t={type:"_$_rpct-window-stream_$_",payload:e};return JSON.stringify(t)}function w(e={}){const{unpack:t=v}=e,n=new _.EventEmitter;return{stream:n,handler:e=>{const i=t(e);i!==m.WINDOW_STREAM_DATA_FAIL&&n.emit("data",i)}}}m.WINDOW_STREAM_DATA_FAIL=Symbol("WINDOW_STREAM_DATA_FAIL"),m.defaultWindowStreamDataUnpacker=v,m.defaultWindowStreamDataPacker=b,m.createWindowReadStream=function(e,t={}){const{stream:n,handler:i}=w(t);return e.addEventListener("message",i),{stream:n,disposer:()=>{e.removeEventListener("message",i)}}},m.createWindowReadStreamHandler=w;class y extends _.EventEmitter{constructor(e,t){super(),this.window=e,this.opts=t,this.packer=t.pack||b,this.targetOrigin=t.targetOrigin||"*"}write(e,t,n){"function"==typeof t&&(n=t);const i=this.packer(e);return this.window.postMessage(i,this.targetOrigin),n&&n(),!0}}m.WindowWriteStream=y,m.createWindowWriteStream=function(e,t={}){return new y(e,t)};var O={},C=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{l(i.next(e))}catch(t){s(t)}}function a(e){try{l(i.throw(e))}catch(t){s(t)}}function l(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(r,a)}l((i=i.apply(e,t||[])).next())})};Object.defineProperty(O,"__esModule",{value:!0}),O.DuplexJsonStreamTransport=class{constructor(e,t=o.DefaultConfig,n=""){this.debugName=n,this.config=o.DefaultConfig,this.pending=new s.TicketList,this.setConfig(t),this.stream=e,e.on("data",e=>C(this,void 0,void 0,function*(){let t;t=e instanceof Uint8Array?e.toString():"object"==typeof e?e:`${e}`,this.config.debug&&console.log(`StreamIOTransport_${n} received message: "${t}"`);let i=e;try{"string"==typeof t&&(i=JSON.parse(t))}catch(o){throw o}if("object"!=typeof i)throw new Error(`StreamIOTransport_${n} wrong message type; should be object`);if(!Object.keys(i).includes("uuid"))throw new Error(`StreamIOTransport_${n} wrong message type; should have uuid`);if(this.pending.hasUUID(i.uuid))this.config.debug&&console.log(`StreamIOTransport_${n}: found pending`,i.uuid),this.pending.answer(i.uuid,i,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${n}: forEach requestHandler`);const e=yield this.requestHandler(i.data);this.stream.write(JSON.stringify({uuid:i.uuid,data:e}))}}))}request(e){const t={uuid:this.pending.nextUUID(),data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(JSON.stringify(t)),n}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var T={},S=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{l(i.next(e))}catch(t){s(t)}}function a(e){try{l(i.throw(e))}catch(t){s(t)}}function l(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(r,a)}l((i=i.apply(e,t||[])).next())})};Object.defineProperty(T,"__esModule",{value:!0}),T.DuplexStreamTransport=class{constructor(e,t=o.DefaultConfig,n=""){this.debugName=n,this.config=o.DefaultConfig,this.pending=new s.TicketList,this.setConfig(t),this.stream=e,e.on("data",e=>S(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${n} received message: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${n} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${n} wrong message type`);if(this.pending.hasUUID(e.uuid))this.config.debug&&console.log(`StreamIOTransport_${n}: found pending`,e.uuid),this.pending.answer(e.uuid,e,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${n}: forEach requestHandler`);const t=yield this.requestHandler(e.data);this.stream.write({uuid:e.uuid,data:t})}}))}request(e){const t={uuid:this.pending.nextUUID(),data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(t),n}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var $={};function R(e){for(var t in e)$.hasOwnProperty(t)||($[t]=e[t])}Object.defineProperty($,"__esModule",{value:!0}),R(t({})),R(o),R(O),R(T),R(u),R(l),R(s),R(i),R(m),R(g);var A={};Object.defineProperty(A,"__esModule",{value:!0}),A.FigmaPluginWriteStream=class extends g.EventEmitter{constructor(e){super(),this.figma=e}write(e,t,n){return"function"==typeof t&&(n=t),this.figma.ui.postMessage(e),n&&n(),!0}};var I={};function E(e){for(var t in e)I.hasOwnProperty(t)||(I[t]=e[t])}Object.defineProperty(I,"__esModule",{value:!0});const D=t({});return E($),E(A),I.connectToPlugin=function(e){const t=m.createWindowReadStream(window,{unpack:e=>e.data.pluginMessage}).stream,n=m.createWindowWriteStream(parent,{pack:e=>({pluginMessage:e})}),i=new u.StreamTransport(t,n,void 0,"plugin ui");return new D.Api(e,i)},I.connectToUI=function(e,t){const n=new A.FigmaPluginWriteStream(e),i=new g.EventEmitter;e.ui.onmessage=(e=>{i.emit("data",e)});const o=new u.StreamTransport(i,n,void 0,"plugin back");return new D.Api(t,o)},I});