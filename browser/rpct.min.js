!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).RPCT=e()}}(function(){var e=function(e){var t;return function(n){return t||e(t={exports:{},parent:n},t.exports),t.exports}},t=e(function(e,t){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0}),t.Api=t.ApiProtocolArgTypeFlag=void 0;const r=n({});var i;!function(e){e[e.none=0]="none",e[e.value=1]="value",e[e.callback=2]="callback",e[e.proxy=4]="proxy",e[e.buffer=5]="buffer",e[e.extension=65536]="extension"}(i=t.ApiProtocolArgTypeFlag||(t.ApiProtocolArgTypeFlag={})),t.Api=class{constructor(e,t,n={}){this.handleRemoteCall=(e=>o(this,void 0,void 0,function*(){const t=this.requestCounter();this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: "${JSON.stringify(e)}" rid=${t}`);const n=e;let o;if(!n)throw new Error("Api: handleRemoteCall failed, undefined data");this._hook_preHandleRemoteCall(n,t);const r=this._hook_handleRemoteCallPickMethod(n,t);if(r)o=r;else{if(!n.method)return console.error("no method field, checkout middlewares, protocol="+JSON.stringify(n)),{data:void 0,exception:"no method field, checkout middlewares"};if(!this.methods||!this.methods[n.method])return console.error(`method '${n.method}' not found`),{data:void 0,exception:`method '${n.method}' not found`};this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: found selfMethod data.method="${n.method}"`),o=this.methods[n.method]}this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: processing data.args`);const s=n.args.map((e,n)=>{return this._hook_unpackArg(e,n,t)||(e.type===i.value?e.value:void 0)});this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: invoking func`);try{const e=yield o(...s);return this._hook_postHandleRemoteCall(t),{return:this._hook_packReturnValue(e,t)||{type:i.value,value:e}}}catch(a){return{exception:`${a}`}}})),this._send=(e=>o(this,void 0,void 0,function*(){const t=this.requestCounter();this.config.debug&&console.log(`Api_${this.debugName} call: params="${JSON.stringify(e)}" rid=${t}`),this._hook_call(e,t);const n={method:e.method,callback:e.callback,args:e.args.map((e,n)=>{return this._hook_packArg(e,n,t)||{type:i.value,value:e}})};this.config.debug&&console.log(`Api_${this.debugName} call: sending request to transport`);const o=yield this.transport.request(n);if(this._hook_postCall(e,t),"exception"in o)throw o.exception;return this._hook_unpackReturnValue(o.return,t)||(o.return.type===i.value?o.return.value:void console.warn("unknown data return type, checkout middlewares"))})),this.callMethod=((e,...t)=>this._send({method:e,args:t})),this.call=((e,...t)=>this._send({method:e,args:t})),this.requestCounter=l.simpleCountGenerator(),this.hooks=s.reduce((e,t)=>Object.assign(e,{[t]:[]}),{}),this._hook_call=((e,t)=>{if(0===this.hooks.call.length)return;const n=Object.assign(Object.assign({},e),{args:[...e.args]});for(const o of this.hooks.call)o(e,n,t)}),this._hook_postCall=((e,t)=>{if(0!==this.hooks.postCall.length)for(const n of this.hooks.postCall)n(e,t)}),this._hook_preHandleRemoteCall=((e,t)=>{if(0!==this.hooks.preHandleRemoteCall.length)for(const n of this.hooks.preHandleRemoteCall)n(e,t)}),this._hook_handleRemoteCallPickMethod=((e,t)=>{if(0===this.hooks.handleRemoteCallPickMethod.length)return;let n;for(const o of this.hooks.handleRemoteCallPickMethod)n=o(n,e,t);return n}),this._hook_postHandleRemoteCall=(e=>{if(0!==this.hooks.postHandleRemoteCall.length)for(const t of this.hooks.postHandleRemoteCall)t(e)}),this._hook_packArg=((e,t,n)=>{if(0===this.hooks.packArg.length)return;let o=void 0;for(const r of this.hooks.packArg)o=r(o,e,t,n);return o}),this._hook_unpackArg=((e,t,n)=>{if(0===this.hooks.unpackArg.length)return;let o=void 0;for(const r of this.hooks.unpackArg)o=r(o,e,t,n);return o}),this._hook_packReturnValue=((e,t)=>{if(0===this.hooks.packReturnValue.length)return e;let n=void 0;for(const o of this.hooks.packReturnValue)n=o(n,e,t);return n}),this._hook_unpackReturnValue=((e,t)=>{if(0===this.hooks.unpackReturnValue.length)return e;let n=void 0;for(const o of this.hooks.unpackReturnValue)n=o(n,e,t);return n}),this.addMiddleware=(e=>o(this,void 0,void 0,function*(){e.install&&e.install.call(e,this,e);for(const t of s)e[t]&&this.hooks[t].push(e[t].bind(e))}));const{config:a=d.DefaultConfig,debugName:c="",middlewares:u=[r.callbacksMiddleware().middleware]}=n;this.nextUUID=a.uuidGeneratorFactory(),this.methods=e,this.transport=t,this.config=a,this.debugName=c,t.setRequestHandler(this.handleRemoteCall);for(const o of u)this.addMiddleware(o)}};const s=["call","postCall","preHandleRemoteCall","handleRemoteCallPickMethod","postHandleRemoteCall","packArg","unpackArg","packReturnValue","unpackReturnValue"]}),n=e(function(e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.callbacksMiddleware=n.bindCallback=n.appendCallbackOptions=n.defaultCallbackOptions=n.CALLBACK_OPTIONS_SYMBOL=void 0;const o=t({});n.CALLBACK_OPTIONS_SYMBOL=Symbol("callback options"),n.defaultCallbackOptions=(e=>({noAutoFree:!1})),n.appendCallbackOptions=((e,t)=>h.setObjectOptions(e,n.CALLBACK_OPTIONS_SYMBOL,Object.assign(Object.assign({},h.getObjectOptions(e,n.CALLBACK_OPTIONS_SYMBOL,n.defaultCallbackOptions)),t))),n.bindCallback=(e=>n.appendCallbackOptions(e,{noAutoFree:!0})),n.callbacksMiddleware=(()=>{const e={},t={};let r;const i=(e,t)=>{const o=h.getObjectOptions(e[t],n.CALLBACK_OPTIONS_SYMBOL,void 0);o&&o.noAutoFree||delete e[t]},s=(n,i,s)=>{if("function"==typeof n){const a=`${r.nextUUID()}`;return e[s]||(e[s]=[]),e[s].push(a),t[a]=n,r.config.debug&&console.log(`Api_${r.debugName} call: found func arg at ${i} index, bound a callback as callbackUUID="${a}"`),{type:o.ApiProtocolArgTypeFlag.callback,callback:a}}},a=(e,t,n)=>{if(e.type===o.ApiProtocolArgTypeFlag.callback)return r.config.debug&&console.log(`Api_${r.debugName} handleRemoteCall: callback at ${t} arg index, returning proxy`),(...n)=>(r.config.debug&&console.log(`Api_${r.debugName} handleRemoteCall: proxy call for ${t} arg index, callbackArgs="${JSON.stringify(n)}", callback="${e.callback}"`),r._send({callback:e.callback,args:n}))};return{middleware:{install(e){r=e},postCall(n,o){if(e[o]){for(const n of e[o])i(t,n);delete e[o]}},packArg:(e,t,n,o)=>s(t,n,o),unpackArg:(e,t,n,o)=>a(t,n),packReturnValue:(e,t,n)=>s(t,-1,n),unpackReturnValue:(e,t,n)=>a(t,-1),handleRemoteCallPickMethod(e,n,o){if(n.callback)return r.config.debug&&console.log(`Api_${r.debugName} handleRemoteCall: it has a callback call request data.callback="${n.callback}"`),t[n.callback]?(r.config.debug&&console.log(`Api_${r.debugName} handleRemoteCall: found callback="${n.callback}"`),t[n.callback]):void console.error(`callback '${n.method}' not found`)}},freeCallback:e=>{const n=Object.entries(t).find(([,t])=>t===e);if(n){const[e]=n;delete t[e]}}}})}),o={};Object.defineProperty(o,"__esModule",{value:!0}),o.asTypedEventEmitter=void 0,o.asTypedEventEmitter=function(e){return e};var r={},i=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var o=Array(e),r=0;for(t=0;t<n;t++)for(var i=arguments[t],s=0,a=i.length;s<a;s++,r++)o[r]=i[s];return o};Object.defineProperty(r,"__esModule",{value:!0}),r.EventEmitter=void 0;var s=function(){var e=this;this.events={},this.maxListeners=1/0,this.emit=function(t){for(var n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];if(e.events[t]){for(var r=e.events[t].length,i=0,s=e.events[t];i<s.length;i++)s[i].apply(void 0,n);return!!r}return!1},this.on=function(t,n){return e.addListener(t,n),e},this.once=function(t,n){var o=function(){for(var r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];n.apply(void 0,r),e.removeListener(t,o)};return e.addListener(t,o),e},this.addListener=function(t,n){return t in e.events?e.events[t].push(n):e.events[t]=[n],e.maxListeners!==1/0&&e.maxListeners<=e.events[t].length&&console.warn('Maximum event listeners for "'+t+'" event!'),e},this.removeListener=function(t,n){if(t in e.events){var o=e.events[t].indexOf(n);-1!==o&&e.events[t].splice(o,1)}return e},this.hasListeners=function(t){return e.events[t]&&!!e.events[t].length},this.prependListener=function(t,n){return t in e.events?e.events[t].unshift(n):e.events[t]=[n],e},this.prependOnceListener=function(t,n){var o=function(){for(var r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];n.apply(void 0,r),e.removeListener(t,o)};return e.prependListener(t,o),e},this.off=function(t,n){return e.removeListener(t,n)},this.removeAllListeners=function(t){return delete e.events[t],e},this.setMaxListeners=function(t){return e.maxListeners=t,e},this.getMaxListeners=function(){return e.maxListeners},this.listeners=function(t){return i(e.events[t])},this.rawListeners=function(t){return e.events[t]},this.eventNames=function(){return Object.keys(e.events)},this.listenerCount=function(t){return e.events[t]&&e.events[t].length||0}};r.EventEmitter=s;var a={},c=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),u=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||c(t,e,n)};Object.defineProperty(a,"__esModule",{value:!0}),u(o,a),u(r,a);var l={};Object.defineProperty(l,"__esModule",{value:!0}),l.unsafeUUIDGenerator=l.simpleCountGenerator=l.cloneJSON=void 0,l.cloneJSON=function(e){return JSON.parse(JSON.stringify(e))},l.simpleCountGenerator=function(e=0){let t=e;return()=>(t>=Number.MAX_SAFE_INTEGER-5&&(t=0),++t)},l.unsafeUUIDGenerator=function(){return()=>`${Date.now()}-${Math.floor(9999*Math.random()).toString(16)}-${Math.floor(9999*Math.random()).toString(16)}`};var d={};Object.defineProperty(d,"__esModule",{value:!0}),d.DefaultConfig=void 0,d.DefaultConfig={version:"0.1.0",debug:!1,uuidGeneratorFactory:l.unsafeUUIDGenerator};var h={};Object.defineProperty(h,"__esModule",{value:!0}),h.setObjectOptions=h.getObjectOptions=void 0,h.getObjectOptions=function(e,t,n){let o=e[t];return o||(o="function"==typeof n?n(e):n),o},h.setObjectOptions=function(e,t,n){return e[t]="function"==typeof n?n(e):n,e};var p={};Object.defineProperty(p,"__esModule",{value:!0}),p.isTransportProtocolApi=p.isTransportProtocolReturnable=p.transportProtocolToResponse=void 0,p.transportProtocolToResponse=function(e){return"exception"in e?{exception:e.exception}:{return:e.return}},p.isTransportProtocolReturnable=function(e){return"exception"in e||"return"in e},p.isTransportProtocolApi=function(e){return"api"in e};var f={};Object.defineProperty(f,"__esModule",{value:!0}),f.TicketList=void 0;class g extends Error{constructor(e,t){super(e),this.uuid=t}}class m{constructor(){this.ask=(e=>{const t=null===e?this.nextUUID():e,n=new Promise((e,n)=>{this.pendingTickets[t]=((o,r)=>{o||!r?(delete this.pendingTickets[t],e(o)):n(r)})});return{uuid:t,answer:n}}),this.answer=((e,t,n=!1)=>{if(!n&&!this.hasUUID(e))throw new g(`no pending ticket for uuid="${e}"`,e);const o=this.pendingTickets[e];delete this.pendingTickets[e],o(t)}),this.pendingTickets={},this.hasUUID=(e=>e in this.pendingTickets),this.rejectTicket=((e,t=!1)=>{if(!this.hasUUID(e))return;const n=this.pendingTickets[e];if(delete this.pendingTickets[e],"ignore errors"===t)try{n(void 0,m.TICKET_REJECTED)}catch(o){}else n(void 0,m.TICKET_REJECTED)}),this.nextUUID=(()=>{let e=0;return()=>{e>=Number.MAX_SAFE_INTEGER-5&&(e=0);do{e++}while(this.hasUUID(e));return e}})()}}f.TicketList=m,m.TICKET_REJECTED=Symbol("TICKET_REJECTED");var v={},_=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(v,"__esModule",{value:!0}),v.DuplexJsonStreamTransport=void 0,v.DuplexJsonStreamTransport=class{constructor(e,t=d.DefaultConfig,n=""){this.debugName=n,this.config=d.DefaultConfig,this.pending=new f.TicketList,this.setConfig(t),this.stream=e,e.on("data",e=>_(this,void 0,void 0,function*(){let t;t=e instanceof Uint8Array?e.toString():"object"==typeof e?e:`${e}`,this.config.debug&&console.log(`StreamIOTransport_${n} received message: "${t}"`);let o=e;try{"string"==typeof t&&(o=JSON.parse(t))}catch(r){throw r}if("object"!=typeof o)throw new Error(`StreamIOTransport_${n} wrong message type; should be object`);if(!Object.keys(o).includes("uuid"))throw new Error(`StreamIOTransport_${n} wrong message type; should have uuid`);if(this.pending.hasUUID(o.uuid)){if(this.config.debug&&console.log(`StreamIOTransport_${n}: found pending`,o.uuid),!p.isTransportProtocolReturnable(o))throw new Error(`StreamIOTransport_${n}: msg should be returnable`);this.pending.answer(o.uuid,o,"no uuid check")}else{if(this.config.debug&&console.log(`StreamIOTransport_${n}: forEach requestHandler`),!("api"in o))throw new Error(`StreamIOTransport_${n}: chunkProtocol without .api`);{const e=yield this.requestHandler(o.api);this.stream.write(JSON.stringify(Object.assign(e,{uuid:o.uuid})))}}}))}request(e){const t={uuid:this.pending.nextUUID(),api:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(JSON.stringify(t)),n.catch(e=>({data:void 0,exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var b={},w=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(b,"__esModule",{value:!0}),b.DuplexStreamTransport=void 0,b.DuplexStreamTransport=class{constructor(e,t=d.DefaultConfig,n=""){this.debugName=n,this.config=d.DefaultConfig,this.pending=new f.TicketList,this.setConfig(t),this.stream=e,e.on("data",e=>w(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${n} received message: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${n} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${n} wrong message type`);if(this.pending.hasUUID(e.uuid)){if(this.config.debug&&console.log(`StreamIOTransport_${n}: found pending`,e.uuid),!p.isTransportProtocolReturnable(e))throw new Error(`StreamIOTransport_${n}: msg should be returnable`);this.pending.answer(e.uuid,e,"no uuid check")}else{if(this.config.debug&&console.log(`StreamIOTransport_${n}: forEach requestHandler`),!p.isTransportProtocolApi(e))throw new Error(`StreamIOTransport_${n}: chunkProtocol without .api`);{const t=yield this.requestHandler(e.api);this.stream.write(Object.assign(t,{uuid:e.uuid}))}}}))}request(e){const t={uuid:this.pending.nextUUID(),api:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(t),n.catch(e=>({exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var k={};Object.defineProperty(k,"__esModule",{value:!0}),k.asDuplexStream=k.asWritableStream=k.asReadableStream=void 0,k.asReadableStream=function(e){return e},k.asWritableStream=function(e){return e},k.asDuplexStream=function(e){return e};var O={},y=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(O,"__esModule",{value:!0}),O.StreamTransport=void 0,O.StreamTransport=class{constructor(e,t,n=d.DefaultConfig,o=""){this.debugName=o,this.config=d.DefaultConfig,this.pending=new f.TicketList,this.rstream=k.asReadableStream(e),this.wstream=k.asWritableStream(t),this.setConfig(n),this.rstream.on("data",e=>y(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${o} onData: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${o} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${o} wrong message type`);if(this.pending.hasUUID(e.uuid)){if(this.config.debug&&console.log(`StreamIOTransport_${o}: found pending, answering pending ticket uuid="${e.uuid}"`),!p.isTransportProtocolReturnable(e))throw new Error(`StreamIOTransport_${o}: msg should be returnable`);this.pending.answer(e.uuid,e,"no uuid check")}else{if(this.config.debug&&console.log(`StreamIOTransport_${o}: no pending ticket with this uuid="${e.uuid}", calling requestHandler`),!p.isTransportProtocolApi(e))throw new Error(`StreamIOTransport_${o}: msg should has api`);{const t=yield this.requestHandler(e.api);this.config.debug&&console.log(`StreamIOTransport_${o}: requestHandler for uuid="${e.uuid}", answered data: "${JSON.stringify(t)}"`),this.wstream.write(Object.assign(t,{uuid:e.uuid}))}}}))}request(e){const t=this.pending.nextUUID(),n={uuid:t,api:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request with uuid="${t}", data="${JSON.stringify(e)}", new pending ticket`);const{answer:o}=this.pending.ask(n.uuid);return this.wstream.write(n),o.catch(e=>({exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var T={},S=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),C=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),P=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&S(t,e,n);return C(t,e),t};Object.defineProperty(T,"__esModule",{value:!0}),T.createWindowWriteStream=T.WindowWriteStream=T.createWindowReadStreamHandler=T.createWindowReadStream=T.defaultWindowStreamDataPacker=T.defaultWindowStreamDataUnpacker=T.WINDOW_STREAM_DATA_FAIL=void 0;const A=P(a);function $(e){try{const n=JSON.parse(e.data);if("object"==typeof n&&"_$_rpct-window-stream_$_"===n.type&&"payload"in n)return n.payload}catch(t){}return T.WINDOW_STREAM_DATA_FAIL}function R(e){const t={type:"_$_rpct-window-stream_$_",payload:e};return JSON.stringify(t)}function I(e={}){const{unpack:t=$}=e,n=new A.EventEmitter;return{stream:n,handler:e=>{const o=t(e);o!==T.WINDOW_STREAM_DATA_FAIL&&n.emit("data",o)}}}T.WINDOW_STREAM_DATA_FAIL=Symbol("WINDOW_STREAM_DATA_FAIL"),T.defaultWindowStreamDataUnpacker=$,T.defaultWindowStreamDataPacker=R,T.createWindowReadStream=function(e,t={}){const{stream:n,handler:o}=I(t);return e.addEventListener("message",o),{stream:n,disposer:()=>{e.removeEventListener("message",o)}}},T.createWindowReadStreamHandler=I;class x extends A.EventEmitter{constructor(e,t){super(),this.window=e,this.opts=t,this.packer=t.pack||R,this.targetOrigin=t.targetOrigin||"*"}write(e,t,n){"function"==typeof t&&(n=t);const o=this.packer(e);return this.window.postMessage(o,this.targetOrigin),n&&n(),!0}}T.WindowWriteStream=x,T.createWindowWriteStream=function(e,t={}){return new x(e,t)};var D={};Object.defineProperty(D,"__esModule",{value:!0}),D.proxyMapRemote=void 0,D.proxyMapRemote=function(e){return new Proxy({},{get:(t,n,o)=>(...t)=>e.call(n,...t)})};var E={};Object.defineProperty(E,"__esModule",{value:!0}),E.watchCascade=E.watchCascadePair=E.watchProperty=E.Watcher=void 0;const j=300,M=(e,t)=>e===t;class L extends a.EventEmitter{constructor(e){super(),this.emitChange=(e=>{const t=this.lastValue;this.lastValue=e,this.emit("change",e,t)}),this.setPropListenerDisposer=(e=>{this.disposePropListener(),this._propListenerDisposer=e}),this.rebindTo=(e=>{const t=this.rawListeners("change");e.rawListeners("change").push(...t),t.splice(0,t.length)}),this.rebindDisposePropListener=(e=>{this.rebindTo(e),this.disposePropListener()}),this.disposePropListener=(()=>{this.propListenerDisposer&&(this.propListenerDisposer(),this._propListenerDisposer=void 0)}),this._propListenerDisposer=e}get propListenerDisposer(){return this._propListenerDisposer}}function N(e,t){let n=new L;return e.on("change",e=>{n=t(e,n)}),n.on("dispose",()=>{e.emit("dispose")}),n}E.Watcher=L,E.watchProperty=function(e,t={}){const{pollInterval:n=j,isEqual:o=M,watcher:r=new L}=t;let{emitOnStart:i=!0}=t,s=e();const a=setInterval(()=>{const t=e();i&&(r.emitChange(t),i=!1),o(s,t)||(r.emitChange(t),s=t)},n);return r.setPropListenerDisposer(()=>{clearInterval(a)}),r},E.watchCascadePair=N,E.watchCascade=function e(t,n){const o=N(t,n),r=t=>{e(o,t)};return Object.assign(r,{last:o}),r};var U={};Object.defineProperty(U,"__esModule",{value:!0}),U.FigmaPluginWriteStream=void 0,U.FigmaPluginWriteStream=class extends a.EventEmitter{constructor(e){super(),this.figma=e}write(e,t,n){return"function"==typeof t&&(n=t),this.figma.ui.postMessage(e),n&&n(),!0}};var W={},q=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(W,"__esModule",{value:!0}),W.connectToUI=W.connectToPlugin=void 0;const H=t({});W.connectToPlugin=function(e){return q(this,void 0,void 0,function*(){const t=T.createWindowReadStream(window,{unpack:e=>e.data.pluginMessage}).stream,n=T.createWindowWriteStream(parent,{pack:e=>({pluginMessage:e})}),o=new O.StreamTransport(t,n,void 0,"plugin ui"),r=new H.Api(Object.assign(e,{}),o);return new Promise(e=>q(this,void 0,void 0,function*(){let t=!0;for(;t;)r.call("$connectToUI_handshake",()=>{t=!1,e(r)}),yield new Promise(e=>setTimeout(e,200))}))})},W.connectToUI=function(e,t){return q(this,void 0,void 0,function*(){const n=new U.FigmaPluginWriteStream(e),o=new a.EventEmitter;e.ui.onmessage=(e=>{o.emit("data",e)});const r=new O.StreamTransport(o,n,void 0,"plugin back");return new Promise(e=>{let n=!1;const o=new H.Api(Object.assign(t,{$connectToUI_handshake(t){n||(n=!0,t(),e(o))}}),r)})})};var F={};Object.defineProperty(F,"__esModule",{value:!0}),F.connectToDOM=void 0,F.connectToDOM=function(e,t){const n=T.createWindowWriteStream(t),{stream:o,disposer:r}=T.createWindowReadStream(e);return new O.StreamTransport(o,n)};var J={},V=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),B=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||V(t,e,n)};return Object.defineProperty(J,"__esModule",{value:!0}),B(a,J),B(t({}),J),B(d,J),B(v,J),B(b,J),B(O,J),B(p,J),B(l,J),B(T,J),B(k,J),B(D,J),B(E,J),B(U,J),B(W,J),B(n({}),J),B(F,J),J});