!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).RPCT=e()}}(function(){var e=function(e){var t;return function(n){return t||e(t={exports:{},parent:n},t.exports),t.exports}},t=e(function(e,t){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{c(i.next(e))}catch(t){s(t)}}function a(e){try{c(i.throw(e))}catch(t){s(t)}}function c(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(r,a)}c((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=n({});var s;!function(e){e[e.none=0]="none",e[e.value=1]="value",e[e.callback=2]="callback",e[e.proxy=4]="proxy",e[e.extension=65536]="extension"}(s=t.ApiProtocolArgTypeFlag||(t.ApiProtocolArgTypeFlag={})),t.Api=class{constructor(e,t,n={}){this.handleRemoteCall=(e=>i(this,void 0,void 0,function*(){const t=this.requestCounter();this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: "${JSON.stringify(e)}" rid=${t}`);const n=e;let i;if(!n)throw new Error("Api: handleRemoteCall failed, undefined data");this._hook_preHandleRemoteCall(n,t);const o=this._hook_handleRemoteCallPickMethod(n,t);if(o)i=o;else{if(!n.method)return console.error("not method & not callback"),{data:void 0,exception:"not method & not callback"};if(!this.methods||!this.methods[n.method])return console.error(`method '${n.method}' not found`),{data:void 0,exception:`method '${n.method}' not found`};this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: found selfMethod data.method="${n.method}"`),i=this.methods[n.method]}this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: processing data.args`);const r=n.args.map((e,n)=>{return this._hook_unpackArg(e,n,t)||(e.type===s.callback?(this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: callback at ${n} arg index, returning proxy`),(...t)=>(this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: proxy call for ${n} arg index, callbackArgs="${JSON.stringify(t)}", callback="${e.callback}"`),this._call({callback:e.callback,args:t}))):e.type===s.value?e.value:void 0)});this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: invoking func`);try{const e=yield i(...r);return this._hook_postHandleRemoteCall(t),{data:this._hook_packReturnValue(e,t)||e}}catch(a){return{data:void 0,exception:`${a}`}}})),this._call=(e=>i(this,void 0,void 0,function*(){const t=this.requestCounter();this.config.debug&&console.log(`Api_${this.debugName} call: params="${JSON.stringify(e)}" rid=${t}`),this._hook_call(e,t);const n={method:e.method,callback:e.callback,args:e.args.map((e,n)=>{return this._hook_packArg(e,n,t)||{type:s.value,value:e}})};this.config.debug&&console.log(`Api_${this.debugName} call: sending request to transport`);const i=yield this.transport.request(n);if(this._hook_postCall(e,t),i.exception)throw i.exception;return this._hook_unpackReturnValue(i.data,t)||i.data})),this.callMethod=((e,...t)=>this._call({method:e,args:t})),this.call=((e,...t)=>this._call({method:e,args:t})),this.requestCounter=c.simpleCountGenerator(),this.hooks=r.reduce((e,t)=>Object.assign(e,{[t]:[]}),{}),this._hook_call=((e,t)=>{if(0===this.hooks.call.length)return;const n=Object.assign({},e,{args:[...e.args]});for(const i of this.hooks.call)i(e,n,t)}),this._hook_postCall=((e,t)=>{if(0!==this.hooks.postCall.length)for(const n of this.hooks.postCall)n(e,t)}),this._hook_preHandleRemoteCall=((e,t)=>{if(0!==this.hooks.preHandleRemoteCall.length)for(const n of this.hooks.preHandleRemoteCall)n(e,t)}),this._hook_handleRemoteCallPickMethod=((e,t)=>{if(0===this.hooks.handleRemoteCallPickMethod.length)return;let n;for(const i of this.hooks.handleRemoteCallPickMethod)n=i(n,e,t);return n}),this._hook_postHandleRemoteCall=(e=>{if(0!==this.hooks.postHandleRemoteCall.length)for(const t of this.hooks.postHandleRemoteCall)t(e)}),this._hook_packArg=((e,t,n)=>{if(0===this.hooks.packArg.length)return;let i=void 0;for(const o of this.hooks.packArg)i=o(i,e,t,n);return i}),this._hook_unpackArg=((e,t,n)=>{if(0===this.hooks.unpackArg.length)return;let i=void 0;for(const o of this.hooks.unpackArg)i=o(i,e,t,n);return i}),this._hook_packReturnValue=((e,t)=>{if(0===this.hooks.packReturnValue.length)return e;let n=void 0;for(const i of this.hooks.packReturnValue)n=i(n,e,t);return n}),this._hook_unpackReturnValue=((e,t)=>{if(0===this.hooks.unpackReturnValue.length)return e;let n=void 0;for(const i of this.hooks.unpackReturnValue)n=i(n,e,t);return n}),this.addMiddleware=(e=>i(this,void 0,void 0,function*(){e.install&&e.install.call(e,this,e);for(const t of r)e[t]&&this.hooks[t].push(e[t].bind(e))}));const{config:a=u.DefaultConfig,debugName:l="",middlewares:d=[o.callbacksMiddleware().middleware]}=n;this.nextUUID=a.uuidGeneratorFactory(),this.methods=e,this.transport=t,this.config=a,this.debugName=l,t.setRequestHandler(this.handleRemoteCall);for(const i of d)this.addMiddleware(i)}};const r=["call","postCall","preHandleRemoteCall","handleRemoteCallPickMethod","postHandleRemoteCall","packArg","unpackArg","packReturnValue","unpackReturnValue"]}),n=e(function(e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const i=t({});n.CALLBACK_OPTIONS_SYMBOL=Symbol("callback options"),n.defaultCallbackOptions=(e=>({noAutoFree:!1})),n.appendCallbackOptions=((e,t)=>l.setObjectOptions(e,n.CALLBACK_OPTIONS_SYMBOL,Object.assign({},l.getObjectOptions(e,n.CALLBACK_OPTIONS_SYMBOL,n.defaultCallbackOptions),t))),n.bindCallback=(e=>n.appendCallbackOptions(e,{noAutoFree:!0})),n.callbacksMiddleware=(()=>{const e={},t={};let o;const s=(e,t)=>{const i=l.getObjectOptions(e[t],n.CALLBACK_OPTIONS_SYMBOL,void 0);i&&i.noAutoFree||delete e[t]};return{middleware:{install(e){o=e},postCall(n,i){if(e[i]){for(const n of e[i])s(t,n);delete e[i]}},packArg(n,s,r,a){if("function"==typeof s){const n=`${o.nextUUID()}`;return e[a]||(e[a]=[]),e[a].push(n),t[n]=s,o.config.debug&&console.log(`Api_${o.debugName} call: found func arg at ${r} index, bound a callback as callbackUUID="${n}"`),{type:i.ApiProtocolArgTypeFlag.callback,callback:n}}},handleRemoteCallPickMethod(e,n,i){if(n.callback)return o.config.debug&&console.log(`Api_${o.debugName} handleRemoteCall: it has a callback call request data.callback="${n.callback}"`),t[n.callback]?(o.config.debug&&console.log(`Api_${o.debugName} handleRemoteCall: found callback="${n.callback}"`),t[n.callback]):void console.error(`callback '${n.method}' not found`)}},freeCallback:e=>{const n=Object.entries(t).find(([,t])=>t===e);if(n){const[e]=n;delete t[e]}}}})}),i={};Object.defineProperty(i,"__esModule",{value:!0}),i.asTypedEventEmitter=function(e){return e};var o={};Object.defineProperty(o,"__esModule",{value:!0});var s=function(){var e=this;this.events={},this.maxListeners=1/0,this.emit=function(t){for(var n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(e.events[t]){for(var o=0,s=e.events[t];o<s.length;o++)s[o].apply(void 0,n);return!!e.events[t].length}return!1},this.on=function(t,n){return e.addListener(t,n),e},this.once=function(t,n){return e.addListener(t,function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];n.apply(void 0,i),e.removeListener(t,n)}),e},this.addListener=function(t,n){return t in e.events?e.events[t].push(n):e.events[t]=[n],e.maxListeners!==1/0&&e.maxListeners<=e.events[t].length&&console.warn('Maximum event listeners for "'+t+'" event!'),e},this.removeListener=function(t,n){if(t in e.events){var i=e.events[t].indexOf(n);-1!==i&&e.events[t].splice(i,1)}return e},this.hasListeners=function(t){return e.events[t]&&!!e.events[t].length},this.prependListener=function(t,n){return t in e.events?e.events[t].unshift(n):e.events[t]=[n],e},this.prependOnceListener=function(t,n){return e.prependListener(t,function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];n.apply(void 0,i),e.removeListener(t,n)}),e},this.off=function(t,n){return e.removeListener(t,n)},this.removeAllListeners=function(t){return delete e.events[t],e},this.setMaxListeners=function(t){return e.maxListeners=t,e},this.getMaxListeners=function(){return e.maxListeners},this.listeners=function(t){return e.events[t].slice()},this.rawListeners=function(t){return e.events[t]},this.eventNames=function(){return Object.keys(e.events)},this.listenerCount=function(t){return e.events[t]&&e.events[t].length||0}};o.EventEmitter=s;var r={};function a(e){for(var t in e)r.hasOwnProperty(t)||(r[t]=e[t])}Object.defineProperty(r,"__esModule",{value:!0}),a(i),a(o);var c={};Object.defineProperty(c,"__esModule",{value:!0}),c.cloneJSON=function(e){return JSON.parse(JSON.stringify(e))},c.simpleCountGenerator=function(e=0){let t=e;return()=>(t>=Number.MAX_SAFE_INTEGER-5&&(t=0),++t)},c.unsafeUUIDGenerator=function(){return()=>`${Date.now()}-${Math.floor(9999*Math.random()).toString(16)}-${Math.floor(9999*Math.random()).toString(16)}`};var u={};Object.defineProperty(u,"__esModule",{value:!0}),u.DefaultConfig={version:"0.1.0",debug:!1,uuidGeneratorFactory:c.unsafeUUIDGenerator};var l={};Object.defineProperty(l,"__esModule",{value:!0}),l.getObjectOptions=function(e,t,n){let i=e[t];return i||(i="function"==typeof n?n(e):n),i},l.setObjectOptions=function(e,t,n){return e[t]="function"==typeof n?n(e):n,e};var d={};Object.defineProperty(d,"__esModule",{value:!0});class h extends Error{constructor(e,t){super(e),this.uuid=t}}class f{constructor(){this.ask=(e=>{const t=null===e?this.nextUUID():e,n=new Promise((e,n)=>{this.pendingTickets[t]=((i,o)=>{i||!o?(delete this.pendingTickets[t],e(i)):n(o)})});return{uuid:t,answer:n}}),this.answer=((e,t,n=!1)=>{if(!n&&!this.hasUUID(e))throw new h(`no pending ticket for uuid="${e}"`,e);const i=this.pendingTickets[e];delete this.pendingTickets[e],i(t)}),this.pendingTickets={},this.hasUUID=(e=>e in this.pendingTickets),this.rejectTicket=((e,t=!1)=>{if(!this.hasUUID(e))return;const n=this.pendingTickets[e];if(delete this.pendingTickets[e],"ignore errors"===t)try{n(void 0,f.TICKET_REJECTED)}catch(i){}else n(void 0,f.TICKET_REJECTED)}),this.nextUUID=(()=>{let e=0;return()=>{e>=Number.MAX_SAFE_INTEGER-5&&(e=0);do{e++}while(this.hasUUID(e));return e}})()}}f.TICKET_REJECTED=Symbol("TICKET_REJECTED"),d.TicketList=f;var p={},g=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{c(i.next(e))}catch(t){s(t)}}function a(e){try{c(i.throw(e))}catch(t){s(t)}}function c(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(r,a)}c((i=i.apply(e,t||[])).next())})};Object.defineProperty(p,"__esModule",{value:!0}),p.DuplexJsonStreamTransport=class{constructor(e,t=u.DefaultConfig,n=""){this.debugName=n,this.config=u.DefaultConfig,this.pending=new d.TicketList,this.setConfig(t),this.stream=e,e.on("data",e=>g(this,void 0,void 0,function*(){let t;t=e instanceof Uint8Array?e.toString():"object"==typeof e?e:`${e}`,this.config.debug&&console.log(`StreamIOTransport_${n} received message: "${t}"`);let i=e;try{"string"==typeof t&&(i=JSON.parse(t))}catch(o){throw o}if("object"!=typeof i)throw new Error(`StreamIOTransport_${n} wrong message type; should be object`);if(!Object.keys(i).includes("uuid"))throw new Error(`StreamIOTransport_${n} wrong message type; should have uuid`);if(this.pending.hasUUID(i.uuid))this.config.debug&&console.log(`StreamIOTransport_${n}: found pending`,i.uuid),this.pending.answer(i.uuid,i,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${n}: forEach requestHandler`);const e=yield this.requestHandler(i.data);this.stream.write(JSON.stringify(Object.assign(e,{uuid:i.uuid})))}}))}request(e){const t={uuid:this.pending.nextUUID(),data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(JSON.stringify(t)),n.catch(e=>({data:void 0,exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var m={},_=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{c(i.next(e))}catch(t){s(t)}}function a(e){try{c(i.throw(e))}catch(t){s(t)}}function c(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(r,a)}c((i=i.apply(e,t||[])).next())})};Object.defineProperty(m,"__esModule",{value:!0}),m.DuplexStreamTransport=class{constructor(e,t=u.DefaultConfig,n=""){this.debugName=n,this.config=u.DefaultConfig,this.pending=new d.TicketList,this.setConfig(t),this.stream=e,e.on("data",e=>_(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${n} received message: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${n} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${n} wrong message type`);if(this.pending.hasUUID(e.uuid))this.config.debug&&console.log(`StreamIOTransport_${n}: found pending`,e.uuid),this.pending.answer(e.uuid,e,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${n}: forEach requestHandler`);const t=yield this.requestHandler(e.data);this.stream.write(Object.assign(t,{uuid:e.uuid}))}}))}request(e){const t={uuid:this.pending.nextUUID(),data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(t),n.catch(e=>({data:void 0,exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var v={};Object.defineProperty(v,"__esModule",{value:!0}),v.asReadableStream=function(e){return e},v.asWritableStream=function(e){return e},v.asDuplexStream=function(e){return e};var b={},k=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{c(i.next(e))}catch(t){s(t)}}function a(e){try{c(i.throw(e))}catch(t){s(t)}}function c(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(r,a)}c((i=i.apply(e,t||[])).next())})};Object.defineProperty(b,"__esModule",{value:!0}),b.StreamTransport=class{constructor(e,t,n=u.DefaultConfig,i=""){this.debugName=i,this.config=u.DefaultConfig,this.pending=new d.TicketList,this.rstream=v.asReadableStream(e),this.wstream=v.asWritableStream(t),this.setConfig(n),this.rstream.on("data",e=>k(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${i} onData: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${i} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${i} wrong message type`);if(this.pending.hasUUID(e.uuid))this.config.debug&&console.log(`StreamIOTransport_${i}: found pending, answering pending ticket uuid="${e.uuid}"`),this.pending.answer(e.uuid,e,"no uuid check");else{this.config.debug&&console.log(`StreamIOTransport_${i}: no pending ticket with this uuid="${e.uuid}", calling requestHandler`);const t=yield this.requestHandler(e.data);this.config.debug&&console.log(`StreamIOTransport_${i}: requestHandler for uuid="${e.uuid}", answered data: "${JSON.stringify(t)}"`),this.wstream.write(Object.assign(t,{uuid:e.uuid}))}}))}request(e){const t=this.pending.nextUUID(),n={uuid:t,data:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request with uuid="${t}", data="${JSON.stringify(e)}", new pending ticket`);const{answer:i}=this.pending.ask(n.uuid);return this.wstream.write(n),i.catch(e=>({data:void 0,exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var w={},y=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(w,"__esModule",{value:!0});const O=y(r);function C(e){try{const n=JSON.parse(e.data);if("object"==typeof n&&"_$_rpct-window-stream_$_"===n.type&&"payload"in n)return n.payload}catch(t){}return w.WINDOW_STREAM_DATA_FAIL}function S(e){const t={type:"_$_rpct-window-stream_$_",payload:e};return JSON.stringify(t)}function T(e={}){const{unpack:t=C}=e,n=new O.EventEmitter;return{stream:n,handler:e=>{const i=t(e);i!==w.WINDOW_STREAM_DATA_FAIL&&n.emit("data",i)}}}w.WINDOW_STREAM_DATA_FAIL=Symbol("WINDOW_STREAM_DATA_FAIL"),w.defaultWindowStreamDataUnpacker=C,w.defaultWindowStreamDataPacker=S,w.createWindowReadStream=function(e,t={}){const{stream:n,handler:i}=T(t);return e.addEventListener("message",i),{stream:n,disposer:()=>{e.removeEventListener("message",i)}}},w.createWindowReadStreamHandler=T;class $ extends O.EventEmitter{constructor(e,t){super(),this.window=e,this.opts=t,this.packer=t.pack||S,this.targetOrigin=t.targetOrigin||"*"}write(e,t,n){"function"==typeof t&&(n=t);const i=this.packer(e);return this.window.postMessage(i,this.targetOrigin),n&&n(),!0}}w.WindowWriteStream=$,w.createWindowWriteStream=function(e,t={}){return new $(e,t)};var A={};Object.defineProperty(A,"__esModule",{value:!0}),A.proxyMapRemote=function(e){return new Proxy({},{get:(t,n,i)=>(...t)=>e.call(n,...t)})};var I={};Object.defineProperty(I,"__esModule",{value:!0});const R=300,x=(e,t)=>e===t;class P extends r.EventEmitter{constructor(e){super(),this.emitChange=(e=>{const t=this.lastValue;this.lastValue=e,this.emit("change",e,t)}),this.setPropListenerDisposer=(e=>{this.disposePropListener(),this._propListenerDisposer=e}),this.rebindTo=(e=>{const t=this.rawListeners("change");e.rawListeners("change").push(...t),t.splice(0,t.length)}),this.rebindDisposePropListener=(e=>{this.rebindTo(e),this.disposePropListener()}),this.disposePropListener=(()=>{this.propListenerDisposer&&(this.propListenerDisposer(),this._propListenerDisposer=void 0)}),this._propListenerDisposer=e}get propListenerDisposer(){return this._propListenerDisposer}}function D(e,t){let n=new P;return e.on("change",e=>{n=t(e,n)}),n.on("dispose",()=>{e.emit("dispose")}),n}I.Watcher=P,I.watchProperty=function(e,t={}){const{pollInterval:n=R,isEqual:i=x,watcher:o=new P}=t;let{emitOnStart:s=!0}=t,r=e();const a=setInterval(()=>{const t=e();s&&(o.emitChange(t),s=!1),i(r,t)||(o.emitChange(t),r=t)},n);return o.setPropListenerDisposer(()=>{clearInterval(a)}),o},I.watchCascadePair=D,I.watchCascade=function e(t,n){const i=D(t,n),o=t=>{e(i,t)};return Object.assign(o,{last:i}),o};var L={};Object.defineProperty(L,"__esModule",{value:!0}),L.FigmaPluginWriteStream=class extends r.EventEmitter{constructor(e){super(),this.figma=e}write(e,t,n){return"function"==typeof t&&(n=t),this.figma.ui.postMessage(e),n&&n(),!0}};var M={},E=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{c(i.next(e))}catch(t){s(t)}}function a(e){try{c(i.throw(e))}catch(t){s(t)}}function c(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(r,a)}c((i=i.apply(e,t||[])).next())})};Object.defineProperty(M,"__esModule",{value:!0});const j=t({});M.connectToPlugin=function(e){return E(this,void 0,void 0,function*(){const t=w.createWindowReadStream(window,{unpack:e=>e.data.pluginMessage}).stream,n=w.createWindowWriteStream(parent,{pack:e=>({pluginMessage:e})}),i=new b.StreamTransport(t,n,void 0,"plugin ui"),o=new j.Api(Object.assign(e,{}),i);return new Promise(e=>E(this,void 0,void 0,function*(){let t=!0;for(;t;)o.call("$connectToUI_handshake",()=>{t=!1,e(o)}),yield new Promise(e=>setTimeout(e,200))}))})},M.connectToUI=function(e,t){return E(this,void 0,void 0,function*(){const n=new L.FigmaPluginWriteStream(e),i=new r.EventEmitter;e.ui.onmessage=(e=>{i.emit("data",e)});const o=new b.StreamTransport(i,n,void 0,"plugin back");return new Promise(e=>{let n=!1;const i=new j.Api(Object.assign(t,{$connectToUI_handshake(t){n||(n=!0,t(),e(i))}}),o)})})};var N={};function U(e){for(var t in e)N.hasOwnProperty(t)||(N[t]=e[t])}return Object.defineProperty(N,"__esModule",{value:!0}),U(r),U(t({})),U(u),U(p),U(m),U(b),U(c),U(w),U(v),U(A),U(I),U(L),U(M),U(n({})),N});