!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).RPCT=e()}}(function(){var e=function(e){var t;return function(n){return t||e(t={exports:{},parent:n},t.exports),t.exports}},t=e(function(e,t){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(t){i(t)}}function a(e){try{u(r.throw(e))}catch(t){i(t)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=n({});var i;!function(e){e[e.none=0]="none",e[e.value=1]="value",e[e.callback=2]="callback",e[e.proxy=4]="proxy",e[e.buffer=5]="buffer",e[e.extension=65536]="extension"}(i=t.ApiProtocolArgTypeFlag||(t.ApiProtocolArgTypeFlag={})),t.Api=class{constructor(e,t,n={}){this.handleRemoteCall=(e=>r(this,void 0,void 0,function*(){const t=this.requestCounter();this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: "${JSON.stringify(e)}" rid=${t}`);const n=e;let r;if(!n)throw new Error("Api: handleRemoteCall failed, undefined data");this._hook_preHandleRemoteCall(n,t);const o=this._hook_handleRemoteCallPickMethod(n,t);if(o)r=o;else{if(!n.method)return console.error("no method field, checkout middlewares, protocol="+JSON.stringify(n)),{data:void 0,exception:"no method field, checkout middlewares"};if(!this.methods||!this.methods[n.method])return console.error(`method '${n.method}' not found`),{data:void 0,exception:`method '${n.method}' not found`};this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: found selfMethod data.method="${n.method}"`),r=this.methods[n.method]}this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: processing data.args`);const s=n.args.map((e,n)=>{return this._hook_unpackArg(e,n,t)||(e.type===i.value?e.value:void 0)});this.config.debug&&console.log(`Api_${this.debugName} handleRemoteCall: invoking func`);try{const e=yield r(...s);return this._hook_postHandleRemoteCall(t),{return:this._hook_packReturnValue(e,t)||{type:i.value,value:e}}}catch(a){return{exception:`${a}`}}})),this._send=(e=>r(this,void 0,void 0,function*(){const t=this.requestCounter();this.config.debug&&console.log(`Api_${this.debugName} call: params="${JSON.stringify(e)}" rid=${t}`),this._hook_call(e,t);const n={method:e.method,callback:e.callback,args:e.args.map((e,n)=>{return this._hook_packArg(e,n,t)||{type:i.value,value:e}})};this.config.debug&&console.log(`Api_${this.debugName} call: sending request to transport`);const r=yield this.transport.request(n);if(this._hook_postCall(e,t),"exception"in r)throw r.exception;return this._hook_unpackReturnValue(r.return,t)||(r.return.type===i.value?r.return.value:void console.warn("unknown data return type, checkout middlewares"))})),this.callMethod=((e,...t)=>this._send({method:e,args:t})),this.call=((e,...t)=>this._send({method:e,args:t})),this.requestCounter=u.simpleCountGenerator(),this.hooks=s.reduce((e,t)=>Object.assign(e,{[t]:[]}),{}),this._hook_call=((e,t)=>{if(0===this.hooks.call.length)return;const n=Object.assign({},e,{args:[...e.args]});for(const r of this.hooks.call)r(e,n,t)}),this._hook_postCall=((e,t)=>{if(0!==this.hooks.postCall.length)for(const n of this.hooks.postCall)n(e,t)}),this._hook_preHandleRemoteCall=((e,t)=>{if(0!==this.hooks.preHandleRemoteCall.length)for(const n of this.hooks.preHandleRemoteCall)n(e,t)}),this._hook_handleRemoteCallPickMethod=((e,t)=>{if(0===this.hooks.handleRemoteCallPickMethod.length)return;let n;for(const r of this.hooks.handleRemoteCallPickMethod)n=r(n,e,t);return n}),this._hook_postHandleRemoteCall=(e=>{if(0!==this.hooks.postHandleRemoteCall.length)for(const t of this.hooks.postHandleRemoteCall)t(e)}),this._hook_packArg=((e,t,n)=>{if(0===this.hooks.packArg.length)return;let r=void 0;for(const o of this.hooks.packArg)r=o(r,e,t,n);return r}),this._hook_unpackArg=((e,t,n)=>{if(0===this.hooks.unpackArg.length)return;let r=void 0;for(const o of this.hooks.unpackArg)r=o(r,e,t,n);return r}),this._hook_packReturnValue=((e,t)=>{if(0===this.hooks.packReturnValue.length)return e;let n=void 0;for(const r of this.hooks.packReturnValue)n=r(n,e,t);return n}),this._hook_unpackReturnValue=((e,t)=>{if(0===this.hooks.unpackReturnValue.length)return e;let n=void 0;for(const r of this.hooks.unpackReturnValue)n=r(n,e,t);return n}),this.addMiddleware=(e=>r(this,void 0,void 0,function*(){e.install&&e.install.call(e,this,e);for(const t of s)e[t]&&this.hooks[t].push(e[t].bind(e))}));const{config:a=c.DefaultConfig,debugName:l="",middlewares:d=[o.callbacksMiddleware().middleware]}=n;this.nextUUID=a.uuidGeneratorFactory(),this.methods=e,this.transport=t,this.config=a,this.debugName=l,t.setRequestHandler(this.handleRemoteCall);for(const r of d)this.addMiddleware(r)}};const s=["call","postCall","preHandleRemoteCall","handleRemoteCallPickMethod","postHandleRemoteCall","packArg","unpackArg","packReturnValue","unpackReturnValue"]}),n=e(function(e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r=t({});n.CALLBACK_OPTIONS_SYMBOL=Symbol("callback options"),n.defaultCallbackOptions=(e=>({noAutoFree:!1})),n.appendCallbackOptions=((e,t)=>l.setObjectOptions(e,n.CALLBACK_OPTIONS_SYMBOL,Object.assign({},l.getObjectOptions(e,n.CALLBACK_OPTIONS_SYMBOL,n.defaultCallbackOptions),t))),n.bindCallback=(e=>n.appendCallbackOptions(e,{noAutoFree:!0})),n.callbacksMiddleware=(()=>{const e={},t={};let o;const i=(e,t)=>{const r=l.getObjectOptions(e[t],n.CALLBACK_OPTIONS_SYMBOL,void 0);r&&r.noAutoFree||delete e[t]},s=(n,i,s)=>{if("function"==typeof n){const a=`${o.nextUUID()}`;return e[s]||(e[s]=[]),e[s].push(a),t[a]=n,o.config.debug&&console.log(`Api_${o.debugName} call: found func arg at ${i} index, bound a callback as callbackUUID="${a}"`),{type:r.ApiProtocolArgTypeFlag.callback,callback:a}}},a=(e,t,n)=>{if(e.type===r.ApiProtocolArgTypeFlag.callback)return o.config.debug&&console.log(`Api_${o.debugName} handleRemoteCall: callback at ${t} arg index, returning proxy`),(...n)=>(o.config.debug&&console.log(`Api_${o.debugName} handleRemoteCall: proxy call for ${t} arg index, callbackArgs="${JSON.stringify(n)}", callback="${e.callback}"`),o._send({callback:e.callback,args:n}))};return{middleware:{install(e){o=e},postCall(n,r){if(e[r]){for(const n of e[r])i(t,n);delete e[r]}},packArg(e,t,n,r){const o=s(t,n,r);return void 0===o?e:o},unpackArg(e,t,n,r){const o=a(t,n);return void 0===o?e:o},packReturnValue(e,t,n){const r=s(t,-1,n);return void 0===r?e:r},unpackReturnValue(e,t,n){const r=a(t,-1);return void 0===r?e:r},handleRemoteCallPickMethod(e,n,r){if(n.callback)return o.config.debug&&console.log(`Api_${o.debugName} handleRemoteCall: it has a callback call request data.callback="${n.callback}"`),t[n.callback]?(o.config.debug&&console.log(`Api_${o.debugName} handleRemoteCall: found callback="${n.callback}"`),t[n.callback]):void console.error(`callback '${n.method}' not found`)}},freeCallback:e=>{const n=Object.entries(t).find(([,t])=>t===e);if(n){const[e]=n;delete t[e]}}}})}),r={};Object.defineProperty(r,"__esModule",{value:!0}),r.asTypedEventEmitter=function(e){return e};var o={};Object.defineProperty(o,"__esModule",{value:!0});var i=function(){var e=this;this.events={},this.maxListeners=1/0,this.emit=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];if(e.events[t]){for(var o=0,i=e.events[t];o<i.length;o++)i[o].apply(void 0,n);return!!e.events[t].length}return!1},this.on=function(t,n){return e.addListener(t,n),e},this.once=function(t,n){return e.addListener(t,function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];n.apply(void 0,r),e.removeListener(t,n)}),e},this.addListener=function(t,n){return t in e.events?e.events[t].push(n):e.events[t]=[n],e.maxListeners!==1/0&&e.maxListeners<=e.events[t].length&&console.warn('Maximum event listeners for "'+t+'" event!'),e},this.removeListener=function(t,n){if(t in e.events){var r=e.events[t].indexOf(n);-1!==r&&e.events[t].splice(r,1)}return e},this.hasListeners=function(t){return e.events[t]&&!!e.events[t].length},this.prependListener=function(t,n){return t in e.events?e.events[t].unshift(n):e.events[t]=[n],e},this.prependOnceListener=function(t,n){return e.prependListener(t,function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];n.apply(void 0,r),e.removeListener(t,n)}),e},this.off=function(t,n){return e.removeListener(t,n)},this.removeAllListeners=function(t){return delete e.events[t],e},this.setMaxListeners=function(t){return e.maxListeners=t,e},this.getMaxListeners=function(){return e.maxListeners},this.listeners=function(t){return e.events[t].slice()},this.rawListeners=function(t){return e.events[t]},this.eventNames=function(){return Object.keys(e.events)},this.listenerCount=function(t){return e.events[t]&&e.events[t].length||0}};o.EventEmitter=i;var s={};function a(e){for(var t in e)s.hasOwnProperty(t)||(s[t]=e[t])}Object.defineProperty(s,"__esModule",{value:!0}),a(r),a(o);var u={};Object.defineProperty(u,"__esModule",{value:!0}),u.cloneJSON=function(e){return JSON.parse(JSON.stringify(e))},u.simpleCountGenerator=function(e=0){let t=e;return()=>(t>=Number.MAX_SAFE_INTEGER-5&&(t=0),++t)},u.unsafeUUIDGenerator=function(){return()=>`${Date.now()}-${Math.floor(9999*Math.random()).toString(16)}-${Math.floor(9999*Math.random()).toString(16)}`};var c={};Object.defineProperty(c,"__esModule",{value:!0}),c.DefaultConfig={version:"0.1.0",debug:!1,uuidGeneratorFactory:u.unsafeUUIDGenerator};var l={};Object.defineProperty(l,"__esModule",{value:!0}),l.getObjectOptions=function(e,t,n){let r=e[t];return r||(r="function"==typeof n?n(e):n),r},l.setObjectOptions=function(e,t,n){return e[t]="function"==typeof n?n(e):n,e};var d={};Object.defineProperty(d,"__esModule",{value:!0}),d.transportProtocolToResponse=function(e){return"exception"in e?{exception:e.exception}:{return:e.return}},d.isTransportProtocolReturnable=function(e){return"exception"in e||"return"in e},d.isTransportProtocolApi=function(e){return"api"in e};var h={};Object.defineProperty(h,"__esModule",{value:!0});class p extends Error{constructor(e,t){super(e),this.uuid=t}}class f{constructor(){this.ask=(e=>{const t=null===e?this.nextUUID():e,n=new Promise((e,n)=>{this.pendingTickets[t]=((r,o)=>{r||!o?(delete this.pendingTickets[t],e(r)):n(o)})});return{uuid:t,answer:n}}),this.answer=((e,t,n=!1)=>{if(!n&&!this.hasUUID(e))throw new p(`no pending ticket for uuid="${e}"`,e);const r=this.pendingTickets[e];delete this.pendingTickets[e],r(t)}),this.pendingTickets={},this.hasUUID=(e=>e in this.pendingTickets),this.rejectTicket=((e,t=!1)=>{if(!this.hasUUID(e))return;const n=this.pendingTickets[e];if(delete this.pendingTickets[e],"ignore errors"===t)try{n(void 0,f.TICKET_REJECTED)}catch(r){}else n(void 0,f.TICKET_REJECTED)}),this.nextUUID=(()=>{let e=0;return()=>{e>=Number.MAX_SAFE_INTEGER-5&&(e=0);do{e++}while(this.hasUUID(e));return e}})()}}f.TICKET_REJECTED=Symbol("TICKET_REJECTED"),h.TicketList=f;var g={},m=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(t){i(t)}}function a(e){try{u(r.throw(e))}catch(t){i(t)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(g,"__esModule",{value:!0}),g.DuplexJsonStreamTransport=class{constructor(e,t=c.DefaultConfig,n=""){this.debugName=n,this.config=c.DefaultConfig,this.pending=new h.TicketList,this.setConfig(t),this.stream=e,e.on("data",e=>m(this,void 0,void 0,function*(){let t;t=e instanceof Uint8Array?e.toString():"object"==typeof e?e:`${e}`,this.config.debug&&console.log(`StreamIOTransport_${n} received message: "${t}"`);let r=e;try{"string"==typeof t&&(r=JSON.parse(t))}catch(o){throw o}if("object"!=typeof r)throw new Error(`StreamIOTransport_${n} wrong message type; should be object`);if(!Object.keys(r).includes("uuid"))throw new Error(`StreamIOTransport_${n} wrong message type; should have uuid`);if(this.pending.hasUUID(r.uuid)){if(this.config.debug&&console.log(`StreamIOTransport_${n}: found pending`,r.uuid),!d.isTransportProtocolReturnable(r))throw new Error(`StreamIOTransport_${n}: msg should be returnable`);this.pending.answer(r.uuid,r,"no uuid check")}else{if(this.config.debug&&console.log(`StreamIOTransport_${n}: forEach requestHandler`),!("api"in r))throw new Error(`StreamIOTransport_${n}: chunkProtocol without .api`);{const e=yield this.requestHandler(r.api);this.stream.write(JSON.stringify(Object.assign(e,{uuid:r.uuid})))}}}))}request(e){const t={uuid:this.pending.nextUUID(),api:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(JSON.stringify(t)),n.catch(e=>({data:void 0,exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var _={},v=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(t){i(t)}}function a(e){try{u(r.throw(e))}catch(t){i(t)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(_,"__esModule",{value:!0}),_.DuplexStreamTransport=class{constructor(e,t=c.DefaultConfig,n=""){this.debugName=n,this.config=c.DefaultConfig,this.pending=new h.TicketList,this.setConfig(t),this.stream=e,e.on("data",e=>v(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${n} received message: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${n} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${n} wrong message type`);if(this.pending.hasUUID(e.uuid)){if(this.config.debug&&console.log(`StreamIOTransport_${n}: found pending`,e.uuid),!d.isTransportProtocolReturnable(e))throw new Error(`StreamIOTransport_${n}: msg should be returnable`);this.pending.answer(e.uuid,e,"no uuid check")}else{if(this.config.debug&&console.log(`StreamIOTransport_${n}: forEach requestHandler`),!d.isTransportProtocolApi(e))throw new Error(`StreamIOTransport_${n}: chunkProtocol without .api`);{const t=yield this.requestHandler(e.api);this.stream.write(Object.assign(t,{uuid:e.uuid}))}}}))}request(e){const t={uuid:this.pending.nextUUID(),api:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request`,e);const{answer:n}=this.pending.ask(t.uuid);return this.stream.write(t),n.catch(e=>({exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var w={};Object.defineProperty(w,"__esModule",{value:!0}),w.asReadableStream=function(e){return e},w.asWritableStream=function(e){return e},w.asDuplexStream=function(e){return e};var b={},k=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(t){i(t)}}function a(e){try{u(r.throw(e))}catch(t){i(t)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(b,"__esModule",{value:!0}),b.StreamTransport=class{constructor(e,t,n=c.DefaultConfig,r=""){this.debugName=r,this.config=c.DefaultConfig,this.pending=new h.TicketList,this.rstream=w.asReadableStream(e),this.wstream=w.asWritableStream(t),this.setConfig(n),this.rstream.on("data",e=>k(this,void 0,void 0,function*(){if(this.config.debug&&console.log(`StreamIOTransport_${r} onData: "${JSON.stringify(e)}"`),"object"!=typeof e)throw new Error(`StreamIOTransport_${r} wrong message type`);if(!Object.keys(e).includes("uuid"))throw new Error(`StreamIOTransport_${r} wrong message type`);if(this.pending.hasUUID(e.uuid)){if(this.config.debug&&console.log(`StreamIOTransport_${r}: found pending, answering pending ticket uuid="${e.uuid}"`),!d.isTransportProtocolReturnable(e))throw new Error(`StreamIOTransport_${r}: msg should be returnable`);this.pending.answer(e.uuid,e,"no uuid check")}else{if(this.config.debug&&console.log(`StreamIOTransport_${r}: no pending ticket with this uuid="${e.uuid}", calling requestHandler`),!d.isTransportProtocolApi(e))throw new Error(`StreamIOTransport_${r}: msg should has api`);{const t=yield this.requestHandler(e.api);this.config.debug&&console.log(`StreamIOTransport_${r}: requestHandler for uuid="${e.uuid}", answered data: "${JSON.stringify(t)}"`),this.wstream.write(Object.assign(t,{uuid:e.uuid}))}}}))}request(e){const t=this.pending.nextUUID(),n={uuid:t,api:e};this.config.debug&&console.log(`StreamIOTransport_${this.debugName}: making request with uuid="${t}", data="${JSON.stringify(e)}", new pending ticket`);const{answer:r}=this.pending.ask(n.uuid);return this.wstream.write(n),r.catch(e=>({exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var y={},O=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(t){i(t)}}function a(e){try{u(r.throw(e))}catch(t){i(t)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(y,"__esModule",{value:!0}),y.WebWSTransport=class{constructor(e,t=c.DefaultConfig,n=""){this.debugName=n,this.config=c.DefaultConfig,this.pending=new h.TicketList,this.setConfig(t),this.socket=e,e.addEventListener("message",e=>O(this,void 0,void 0,function*(){const t=JSON.parse(e.data);if(this.config.debug&&console.log(`StreamIOTransport_${n} onData: "${JSON.stringify(t)}"`),"object"!=typeof t)throw new Error(`StreamIOTransport_${n} wrong message type`);if(!Object.keys(t).includes("uuid"))throw new Error(`StreamIOTransport_${n} wrong message type`);if(this.pending.hasUUID(t.uuid)){if(this.config.debug&&console.log(`StreamIOTransport_${n}: found pending, answering pending ticket uuid="${t.uuid}"`),!d.isTransportProtocolReturnable(t))throw new Error(`StreamIOTransport_${n}: msg should be returnable`);this.pending.answer(t.uuid,t,"no uuid check")}else{if(this.config.debug&&console.log(`StreamIOTransport_${n}: no pending ticket with this uuid="${t.uuid}", calling requestHandler`),!d.isTransportProtocolApi(t))throw new Error(`StreamIOTransport_${n}: msg should has api`);{const e=yield this.requestHandler(t.api);this.config.debug&&console.log(`StreamIOTransport_${n}: requestHandler for uuid="${t.uuid}", answered data: "${JSON.stringify(e)}"`),this.socket.send(JSON.stringify(Object.assign(e,{uuid:t.uuid})))}}}))}request(e){const t={uuid:this.pending.nextUUID(),api:e},{answer:n}=this.pending.ask(t.uuid);return this.socket.send(JSON.stringify(t)),n.catch(e=>({exception:`${e}`}))}setRequestHandler(e){this.requestHandler=e}getRequestHandler(){return this.requestHandler}setConfig(e){this.config=e,this.pending.nextUUID=this.config.uuidGeneratorFactory()}};var T={},S=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(T,"__esModule",{value:!0});const $=S(s);function C(e){try{const n=JSON.parse(e.data);if("object"==typeof n&&"_$_rpct-window-stream_$_"===n.type&&"payload"in n)return n.payload}catch(t){}return T.WINDOW_STREAM_DATA_FAIL}function I(e){const t={type:"_$_rpct-window-stream_$_",payload:e};return JSON.stringify(t)}function P(e={}){const{unpack:t=C}=e,n=new $.EventEmitter;return{stream:n,handler:e=>{const r=t(e);r!==T.WINDOW_STREAM_DATA_FAIL&&n.emit("data",r)}}}T.WINDOW_STREAM_DATA_FAIL=Symbol("WINDOW_STREAM_DATA_FAIL"),T.defaultWindowStreamDataUnpacker=C,T.defaultWindowStreamDataPacker=I,T.createWindowReadStream=function(e,t={}){const{stream:n,handler:r}=P(t);return e.addEventListener("message",r),{stream:n,disposer:()=>{e.removeEventListener("message",r)}}},T.createWindowReadStreamHandler=P;class A extends $.EventEmitter{constructor(e,t){super(),this.window=e,this.opts=t,this.packer=t.pack||I,this.targetOrigin=t.targetOrigin||"*"}write(e,t,n){"function"==typeof t&&(n=t);const r=this.packer(e);return this.window.postMessage(r,this.targetOrigin),n&&n(),!0}}T.WindowWriteStream=A,T.createWindowWriteStream=function(e,t={}){return new A(e,t)};var R={};Object.defineProperty(R,"__esModule",{value:!0}),R.proxyMapRemote=function(e){return new Proxy({},{get:(t,n,r)=>(...t)=>e.call(n,...t)})};var x={};Object.defineProperty(x,"__esModule",{value:!0});const D=300,E=(e,t)=>e===t;class L extends s.EventEmitter{constructor(e){super(),this.emitChange=(e=>{const t=this.lastValue;this.lastValue=e,this.emit("change",e,t)}),this.setPropListenerDisposer=(e=>{this.disposePropListener(),this._propListenerDisposer=e}),this.rebindTo=(e=>{const t=this.rawListeners("change");e.rawListeners("change").push(...t),t.splice(0,t.length)}),this.rebindDisposePropListener=(e=>{this.rebindTo(e),this.disposePropListener()}),this.disposePropListener=(()=>{this.propListenerDisposer&&(this.propListenerDisposer(),this._propListenerDisposer=void 0)}),this._propListenerDisposer=e}get propListenerDisposer(){return this._propListenerDisposer}}function M(e,t){let n=new L;return e.on("change",e=>{n=t(e,n)}),n.on("dispose",()=>{e.emit("dispose")}),n}x.Watcher=L,x.watchProperty=function(e,t={}){const{pollInterval:n=D,isEqual:r=E,watcher:o=new L}=t;let{emitOnStart:i=!0}=t,s=e();const a=setInterval(()=>{const t=e();i&&(o.emitChange(t),i=!1),r(s,t)||(o.emitChange(t),s=t)},n);return o.setPropListenerDisposer(()=>{clearInterval(a)}),o},x.watchCascadePair=M,x.watchCascade=function e(t,n){const r=M(t,n),o=t=>{e(r,t)};return Object.assign(o,{last:r}),o};var N={};Object.defineProperty(N,"__esModule",{value:!0}),N.FigmaPluginWriteStream=class extends s.EventEmitter{constructor(e){super(),this.figma=e}write(e,t,n){return"function"==typeof t&&(n=t),this.figma.ui.postMessage(e),n&&n(),!0}};var j={},U=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(t){i(t)}}function a(e){try{u(r.throw(e))}catch(t){i(t)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(j,"__esModule",{value:!0});const q=t({});j.connectToPlugin=function(e){return U(this,void 0,void 0,function*(){const t=T.createWindowReadStream(window,{unpack:e=>e.data.pluginMessage}).stream,n=T.createWindowWriteStream(parent,{pack:e=>({pluginMessage:e})}),r=new b.StreamTransport(t,n,void 0,"plugin ui"),o=new q.Api(Object.assign(e,{}),r);return new Promise(e=>U(this,void 0,void 0,function*(){let t=!0;for(;t;)o.call("$connectToUI_handshake",()=>{t=!1,e(o)}),yield new Promise(e=>setTimeout(e,200))}))})},j.connectToUI=function(e,t){return U(this,void 0,void 0,function*(){const n=new N.FigmaPluginWriteStream(e),r=new s.EventEmitter;e.ui.onmessage=(e=>{r.emit("data",e)});const o=new b.StreamTransport(r,n,void 0,"plugin back");return new Promise(e=>{let n=!1;const r=new q.Api(Object.assign(t,{$connectToUI_handshake(t){n||(n=!0,t(),e(r))}}),o)})})};var H={};Object.defineProperty(H,"__esModule",{value:!0}),H.connectToDOM=function(e,t){const n=T.createWindowWriteStream(t),{stream:r,disposer:o}=T.createWindowReadStream(e);return new b.StreamTransport(r,n)};var W={};function J(e){for(var t in e)W.hasOwnProperty(t)||(W[t]=e[t])}return Object.defineProperty(W,"__esModule",{value:!0}),J(s),J(t({})),J(c),J(g),J(_),J(b),J(y),J(d),J(u),J(T),J(w),J(R),J(x),J(N),J(j),J(n({})),J(H),W});